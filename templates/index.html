<!doctype html>

<html lang="en">

  <head>

    <meta charset="utf-8">

    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>James & Heather - Wedding Weekend</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>

      :root {

        color-scheme: light;

        --text-dark: #2b1d42;

        --text-light: #ffffff;

        --bg-accent: rgba(43, 29, 66, 0.75);

        --max-width: 960px;

        --font-sans: "Segoe UI", "Helvetica Neue", Arial, sans-serif;

      }



      * {

        box-sizing: border-box;

      }



      body {

        font-family: var(--font-sans);

        margin: 0;

        background: #f3f0ff;

        color: var(--text-dark);

        line-height: 1.6;

      }



      h1, h2, h3 {

        font-weight: 600;

        margin: 0 0 0.5rem;

      }



      p {

        margin: 0 0 1rem;

      }



      header.hero {

        position: relative;

        display: grid;

        place-items: center;

        text-align: center;

        min-height: 52vh;

        color: var(--text-light);

        background: #18122b;

        overflow: hidden;

      }



      header.hero::before {

        content: "";

        position: absolute;

        inset: 0;

        background: linear-gradient(180deg, rgba(12, 8, 30, 0.35) 0%, rgba(24, 18, 43, 0.85) 100%),

          var(--hero-image, url('/static/images/hero.jpg')) center/cover;

        filter: saturate(1.05);

        z-index: 0;

      }



      header.hero .content {

        position: relative;

        padding: 3rem 1.5rem 3.5rem;

        max-width: var(--max-width);

        z-index: 1;

      }



      header.hero .hero-actions {

        display: flex;

        flex-direction: column;

        align-items: center;

        gap: 1.25rem;

      }



      .hero-rsvp {

        display: flex;

        flex-wrap: wrap;

        justify-content: center;

        gap: 0.75rem;

      }



      .hero-rsvp input {

        flex: 0 1 220px;

        border-radius: 999px;

        border: 1px solid rgba(255, 255, 255, 0.7);

        background: rgba(255, 255, 255, 0.95);

        color: #12082c;

        font-size: 1.05rem;

        padding: 0.75rem 1.25rem;

        letter-spacing: 0.08em;

        text-transform: uppercase;

        text-align: center;

        outline: none;

        transition: box-shadow 0.25s ease, transform 0.25s ease;

      }



      .hero-rsvp input:focus {

        box-shadow: 0 0 0 3px rgba(109, 92, 231, 0.45);

        transform: translateY(-2px);

      }



      .hero-rsvp .rsvp-button {

        padding: 0.75rem 2.25rem;

        font-size: 1.05rem;

      }



      .rsvp-feedback {

        font-size: 0.95rem;

        padding: 0.6rem 1.1rem;

        border-radius: 14px;

        background: rgba(255, 255, 255, 0.16);

        color: rgba(255, 255, 255, 0.9);

        margin: 0;

      }



      .rsvp-feedback + .hero-rsvp {

        margin-top: 0.75rem;

      }



      .rsvp-feedback--success {

        background: rgba(64, 224, 182, 0.25);

        color: #e5fff7;

      }



      .rsvp-feedback--error {

        background: rgba(255, 99, 132, 0.25);

        color: #ffe5ec;

      }



      .sr-only {

        position: absolute;

        width: 1px;

        height: 1px;

        padding: 0;

        margin: -1px;

        overflow: hidden;

        clip: rect(0, 0, 0, 0);

        white-space: nowrap;

        border: 0;

      }



      .hidden {

        display: none;

      }



      #additional-guests {

        margin-top: 2rem;

        padding: 1.5rem;

        background: rgba(255, 255, 255, 0.05);

        border-radius: 12px;

      }



      #additional-guests h2 {

        color: var(--text-light);

        margin-bottom: 1rem;

      }



      #additional-guests h3 {

        color: var(--text-light);

        margin: 1rem 0 0.5rem;

      }



      #additional-guests ul {

        list-style: none;

        padding: 0;

      }



      #additional-guests li {

        padding: 0.5rem 0;

        border-bottom: 1px solid rgba(255, 255, 255, 0.1);

      }



      #additional-guests li:last-child {

        border-bottom: none;

      }



      .toast {

        position: fixed;

        top: 20px;

        right: 20px;

        padding: 1rem 1.5rem;

        background: rgba(64, 224, 182, 0.9);

        color: #e5fff7;

        border-radius: 8px;

        font-weight: 500;

        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);

        z-index: 1000;

        transform: translateX(100%);

        transition: transform 0.3s ease;

        max-width: 300px;

        word-wrap: break-word;

      }



      .toast--visible {

        transform: translateX(0);

      }



      .toast--error {

        background: rgba(255, 99, 132, 0.9);

        color: #ffe5ec;

      }



      .attendance-button:disabled {

        opacity: 0.6;

        cursor: not-allowed;

      }



      .attendance-toggle {

        display: flex;

        flex-wrap: wrap;

        justify-content: center;

        gap: 0.75rem;

        margin-top: 1.25rem;

      }



      .attendance-button {

        appearance: none;

        border: none;

        border-radius: 999px;

        padding: 0.75rem 2.25rem;

        font-size: 1rem;

        font-weight: 600;

        cursor: pointer;

        color: #ffffff;

        transition: opacity 0.3s ease, transform 0.25s ease, box-shadow 0.25s ease;

      }



      .attendance-button--yes {

        background: linear-gradient(120deg, rgba(64, 224, 182, 0.9), rgba(33, 147, 90, 0.95));

        box-shadow: 0 18px 32px rgba(33, 147, 90, 0.35);

      }



      .attendance-button--no {

        background: linear-gradient(120deg, rgba(255, 99, 132, 0.9), rgba(199, 35, 78, 0.95));

        box-shadow: 0 18px 32px rgba(199, 35, 78, 0.35);

      }



      .attendance-button.is-active {

        opacity: 1;

      }



      .attendance-button:not(.is-active) {

        opacity: 0.4;

      }



      .attendance-button:not(.is-active):hover {

        opacity: 0.6;

      }



      .attendance-button:disabled {

        cursor: wait;

        opacity: 0.4;

      }



      .rsvp-button {

        appearance: none;

        border: none;

        border-radius: 999px;

        background: linear-gradient(120deg, rgba(255, 214, 255, 0.9), rgba(109, 92, 231, 0.95));

        color: #12082c;

        font-size: 1.05rem;

        font-weight: 600;

        padding: 0.85rem 2.75rem;

        cursor: pointer;

        box-shadow: 0 18px 32px rgba(18, 8, 44, 0.35);

        transition: transform 0.25s ease, box-shadow 0.25s ease;

      }



      .rsvp-button:hover {

        transform: translateY(-3px) scale(1.02);

        box-shadow: 0 24px 40px rgba(18, 8, 44, 0.4);

      }



      .rsvp-button:active {

        transform: translateY(0);

        box-shadow: 0 12px 24px rgba(18, 8, 44, 0.32);

      }



      header.hero h1 {

        font-size: clamp(2rem, 3.2vw, 3rem);

        letter-spacing: 0.04em;

      }



      header.hero p {

        font-size: clamp(1.05rem, 2vw, 1.25rem);

        margin-bottom: 1.5rem;

      }



      main {

        padding: 0;

      }



      .timeline {

        margin: 0;

        padding: 0;

        list-style: none;

      }



      .timeline > li {

        list-style: none;

      }



      .section {

        position: relative;

        color: var(--text-light);

        margin: 0px;

        padding: 20px 0;

        overflow: hidden;

        isolation: isolate;

      }



      .section::before {

        content: "";

        position: absolute;

        inset: 0;

        background: var(--section-image, #2b1d42) center/cover no-repeat;

        filter: brightness(0.82);

        transform: scale(1.02);

        opacity: 0.88;

        transition: transform 18s ease, opacity 1.2s ease;

        z-index: -2;

      }



      .section::after {

        content: "";

        position: absolute;

        inset: 0;

        background: linear-gradient(

          to bottom,

          rgba(12, 8, 30, 0.8) 0%,

          rgba(12, 8, 30, 0.4) 15%,

          rgba(12, 8, 30, 0.2) 35%,

          rgba(12, 8, 30, 0.2) 65%,

          rgba(12, 8, 30, 0.4) 85%,

          rgba(12, 8, 30, 0.8) 100%

        );

        opacity: 0.68;

        transition: opacity 1.2s ease;

        z-index: -1;

      }



      .section:hover::before {

        transform: scale(1.06);

        opacity: 1;

      }



      .section:hover::after {

        opacity: 0.38;

      }



      .section .inner {
        position: relative;
        max-width: var(--max-width);
        margin: 0 auto;
        padding: clamp(2rem, 4vw, 3.2rem) clamp(1.5rem, 4vw, 2.75rem);
        background: rgba(12, 8, 30, 0.42);
        border-radius: 18px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 28px 48px rgba(12, 8, 30, 0.25);
        backdrop-filter: blur(6px);
      }



      .section h2 {

        font-size: clamp(1.65rem, 2.8vw, 2.4rem);

        margin-bottom: 0.75rem;

        letter-spacing: 0.05em;

        text-transform: uppercase;

      }



      .section h3 {

        font-size: clamp(1.2rem, 2.3vw, 1.6rem);

      }



      .section p, .section li, .section time {

        font-size: clamp(1rem, 2vw, 1.1rem);

        color: rgba(255, 255, 255, 0.92);

      }



      .section ul {

        margin: 0;

        padding-left: 1.25rem;

      }



      .section .note {

        font-style: italic;

        color: rgba(255, 255, 255, 0.82);

      }



      .schedule {

        display: grid;

        gap: 0.75rem;

        margin: 1.35rem 0 0;

        padding: 0;

        list-style: none;

      }



      .schedule-item {

        display: grid;

        grid-template-columns: minmax(90px, 120px) 1fr;

        gap: 0.75rem;

        align-items: start;

        background: rgba(12, 8, 30, 0.5);

        border-radius: 12px;

        padding: 0.85rem 1.05rem;

        border: 1px solid rgba(255, 255, 255, 0.12);

      }



      .schedule-item time {

        font-weight: 600;

        letter-spacing: 0.04em;

      }



      .band-highlight {

        display: flex;

        flex-direction: column;

        gap: 1rem;

        margin-top: 1.25rem;

        margin-bottom: 1.25rem;

        padding: 1.1rem 1.35rem;

        border-radius: 16px;

        background: rgba(255, 255, 255, 0.08);

        border: 1px solid rgba(255, 255, 255, 0.18);

      }



      .band-highlight a {

        color: #ffd6ff;

        text-decoration: underline;

      }



      .insta-grid {

        margin-top: 1.35rem;

        display: grid;

        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));

        gap: 1rem;

      }



      .insta-card {

        position: relative;

        border-radius: 14px;

        overflow: hidden;

        min-height: 220px;

        background: rgba(12, 8, 30, 0.5);

        display: grid;

        grid-template-rows: 1fr auto;

        border: 1px solid rgba(255, 255, 255, 0.18);

      }



      .insta-card img {

        width: 100%;

        height: 100%;

        object-fit: cover;

      }



      .insta-card footer {

        padding: 0.8rem 1rem;

        font-size: 0.9rem;

        color: rgba(255, 255, 255, 0.85);

        background: rgba(12, 8, 30, 0.65);

      }



      .insta-card a {

        color: inherit;

        text-decoration: none;

      }



      .insta-card a:hover {

        text-decoration: underline;

      }



      .upcoming-events {

        margin-top: 1.35rem;

      }



      .upcoming-events h3 {

        color: rgba(255, 255, 255, 0.9);

        margin-bottom: 1rem;

        font-size: 1.1rem;

      }



      .events-grid {

        display: grid;

        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));

        gap: 1rem;

      }



      .event-card {

        background: rgba(12, 8, 30, 0.5);

        border: 1px solid rgba(255, 255, 255, 0.18);

        border-radius: 12px;

        padding: 1rem;

        transition: all 0.2s ease;

      }



      .event-card:hover {

        background: rgba(12, 8, 30, 0.7);

        border-color: rgba(255, 255, 255, 0.3);

      }



      .event-title {

        font-weight: 600;

        color: rgba(255, 255, 255, 0.95);

        margin-bottom: 0.5rem;

        font-size: 1rem;

      }



      .event-date {

        color: rgba(255, 255, 255, 0.8);

        font-size: 0.9rem;

        margin-bottom: 0.3rem;

      }



      .event-venue {

        color: rgba(255, 255, 255, 0.65);

        font-size: 0.85rem;

        margin-bottom: 0.8rem;

      }



      .event-link {

        color: rgba(255, 255, 255, 0.9);

        text-decoration: none;

        font-size: 0.85rem;

        border: 1px solid rgba(255, 255, 255, 0.3);

        padding: 0.4rem 0.8rem;

        border-radius: 6px;

        display: inline-block;

        transition: all 0.2s ease;

      }



      .event-link:hover {

        background: rgba(255, 255, 255, 0.1);

        border-color: rgba(255, 255, 255, 0.5);

        text-decoration: none;

      }



      @media (max-width: 800px) {

        .schedule-item {

          grid-template-columns: minmax(80px, 110px) 1fr;

        }



        .schedule-item p {

          grid-column: 1 / -1;

          margin: 0;

        }

      }



      @media (max-width: 640px) {

        header.hero::before {

          background-position: center top;

        }



        header.hero {

          min-height: 46vh;

        }

      }



      /* Stag and Hen Section Styles */

      .stag-toggle, .hen-toggle {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 0.75rem;
        margin: 1.5rem 0;
      }

      .stag-names, .hen-names {
        margin: 1.5rem 0;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.18);
      }

      .stag-names h3, .hen-names h3 {
        margin: 0 0 0.75rem 0;
        color: #ffd6ff;
        font-size: 1.2rem;
      }

      .stag-names-list, .hen-names-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      .name-tag {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 500;
        border: 1px solid rgba(255, 255, 255, 0.3);
        margin: 3px;
      }

      .name-tag.attending {
        background: rgba(64, 224, 182, 0.2);
        color: #40e0b6;
        border-color: #40e0b6;
      }

      .name-tag.invited {
        background: rgba(255, 193, 7, 0.2);
        color: #ffc107;
        border-color: #ffc107;
      }

      .name-tag.not-attending {
        background: rgba(255, 99, 132, 0.2);
        color: #ff6384;
        border-color: #ff6384;
      }

      .name-tag.not-invited {
        background: rgba(128, 128, 128, 0.2);
        color: #888;
        border-color: #888;
      }

      .stag-ideas, .hen-ideas, .music-requests {
        margin: 1.5rem 0;
      }

      .stag-ideas h3, .hen-ideas h3, .music-requests h3 {
        margin: 0 0 0.75rem 0;
        color: #ffd6ff;
        font-size: 1.2rem;
      }

      .stag-ideas textarea, .hen-ideas textarea, .music-requests textarea {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.1);
        color: #ffffff;
        font-family: inherit;
        font-size: 1rem;
        resize: vertical;
        min-height: 80px;
      }

      .stag-ideas textarea:focus, .hen-ideas textarea:focus, .music-requests textarea:focus {
        outline: none;
        border-color: #ffd6ff;
        box-shadow: 0 0 0 2px rgba(255, 214, 255, 0.3);
      }

      .stag-ideas textarea::placeholder, .hen-ideas textarea::placeholder {
        color: rgba(255, 255, 255, 0.6);
      }

      /* AI Suggestions */
      .stag-ai-suggestions, .hen-ai-suggestions {
        margin-top: 1.5rem;
      }

      .stag-ai-suggestions h3, .hen-ai-suggestions h3 {
        color: rgba(255, 255, 255, 0.95);
        margin-bottom: 0.8rem;
        font-size: 1rem;
      }

      .ai-suggestions-content {
        background: rgba(12, 8, 30, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 8px;
        padding: 1rem;
        color: rgba(255, 255, 255, 0.85);
        font-size: 0.9rem;
        line-height: 1.5;
      }

      .ai-suggestion-item {
        margin-bottom: 0.8rem;
        padding-bottom: 0.8rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .ai-suggestion-item:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
      }

      /* Stay Option Cards */
      .stay-options {
        margin: 2rem 0;
      }

      .stay-options h3 {
        margin: 0 0 1.5rem 0;
        color: #ffd6ff;
        font-size: 1.4rem;
        text-align: center;
      }

      .stay-cards {
        display: flex;
        gap: 0.5rem;
        justify-content: center;
        margin: 1.5rem 0;
      }

      .stay-card {
        background: rgba(0, 0, 0, 0.7);
        border: 2px solid rgba(255, 214, 255, 0.3);
        border-radius: 12px;
        padding: 1.5rem;
        flex: 1;
        min-width: 280px;
        max-width: 350px;
        transition: all 0.3s ease;
        position: relative;
        backdrop-filter: blur(10px);
      }

      .stay-card:hover {
        border-color: #ffd6ff;
        transform: translateY(-4px);
        box-shadow: 0 8px 25px rgba(255, 214, 255, 0.3);
      }

      .stay-card.selected {
        border-color: #ffd6ff;
        background: rgba(255, 214, 255, 0.1);
        box-shadow: 0 4px 20px rgba(255, 214, 255, 0.4);
      }

      .stay-card-header h4 {
        margin: 0 0 0.5rem 0;
        color: #ffd6ff;
        font-size: 1.3rem;
        font-weight: 600;
      }

      .stay-address {
        color: rgba(255, 255, 255, 0.8);
        font-size: 0.9rem;
        display: block;
        margin-bottom: 1rem;
      }

      .stay-card-content p {
        color: rgba(255, 255, 255, 0.9);
        margin: 0 0 1rem 0;
        line-height: 1.5;
        font-size: 0.95rem;
      }

      .map-link {
        color: #ffd6ff;
        text-decoration: none;
        font-size: 0.9rem;
        display: inline-block;
        margin-bottom: 1.5rem;
        transition: color 0.2s ease;
      }

      .map-link:hover {
        color: #ffffff;
        text-decoration: underline;
      }

      .stay-card-actions {
        margin-top: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.8rem;
      }

      .stay-select-btn {
        width: 100%;
        background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
        color: white;
        border: none;
        padding: 0.8rem 1.5rem;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .stay-select-btn:hover {
        background: linear-gradient(135deg, #ff5252, #ff7979);
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
      }

      .stay-select-btn:active {
        transform: translateY(0);
      }

      .stay-select-btn.selected {
        background: linear-gradient(135deg, #4caf50, #66bb6a);
      }

      .stay-select-btn.selected:hover {
        background: linear-gradient(135deg, #43a047, #5cb85c);
      }

      @media (max-width: 768px) {
        .stay-cards {
          flex-direction: column;
          align-items: center;
        }

        .stay-card {
          max-width: 100%;
          min-width: auto;
        }
      }

      .ceremony-names {
        margin: 1.5rem 0;
        display: none;
      }

      .ceremony-names h3 {
        margin: 0 0 0.75rem 0;
        color: #ffd6ff;
        font-size: 1.2rem;
      }

      .ceremony-names-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      .stag-selection, .hen-selection, .ceremony-selection {
        margin: 2rem 0;
        padding: 1.5rem;
        background: rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.18);
      }

      .stag-selection h3, .hen-selection h3, .ceremony-selection h3 {
        margin: 0 0 1.5rem 0;
        color: #ffd6ff;
        font-size: 1.3rem;
        text-align: center;
      }

      .stag-guests, .hen-guests, .ceremony-guests {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .stag-guest, .hen-guest, .ceremony-guest {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .stag-guest-name, .hen-guest-name, .ceremony-guest-name {
        font-weight: 600;
        color: #ffffff;
        font-size: 1.1rem;
        flex: 1;
      }

      .stag-options, .hen-options, .ceremony-options {
        display: flex;
        gap: 0.5rem;
        flex-shrink: 0;
      }

      .stag-option, .hen-option, .ceremony-option {
        padding: 0.4rem 0.8rem;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 6px;
        background: transparent;
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: center;
        min-width: 80px;
      }

      .stag-option:hover, .hen-option:hover, .ceremony-option:hover {
        background: rgb(0 0 0 / 62%);
        border-color: rgba(255, 255, 255, 0.5);
        color: #ffffff;
      }

      .stag-option.is-active, .hen-option.is-active, .ceremony-option.is-active {
        background: rgb(0 0 0 / 62%);
        border-color: #40e0b6;
        color: #40e0b6;
      }

      /* Red styling for "Can't make it" buttons - only when active */
      .stag-option[data-stag="0"].is-active, .hen-option[data-hen="0"].is-active, .ceremony-option[data-ceremony="0"].is-active {
        background: rgb(0 0 0 / 62%);
        border-color: #dc2626;
        color: #dc2626;
      }

      /* Hover states for "Can't make it" buttons */
      .stag-option[data-stag="0"]:hover, .hen-option[data-hen="0"]:hover, .ceremony-option[data-ceremony="0"]:hover {
        background: rgb(0 0 0 / 62%);
        border-color: rgba(220, 38, 38, 0.5);
        color: #dc2626;
      }

      .stag-option:disabled, .hen-option:disabled, .ceremony-option:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .wedding-meal-selection {
        margin: 2rem 0;
        padding: 1.5rem;
        background: rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.18);
      }

      .wedding-meal-selection h3 {
        margin: 0 0 1.5rem 0;
        color: #ffd6ff;
        font-size: 1.3rem;
        text-align: center;
      }

      .wedding-meal-guests {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .wedding-meal-guest {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .wedding-meal-guest-name {
        font-weight: 600;
        color: #ffffff;
        font-size: 1.1rem;
        flex: 1;
      }

      .wedding-meal-options {
        display: flex;
        gap: 0.5rem;
        flex-shrink: 0;
      }

      .wedding-meal-option {
        padding: 0.4rem 0.8rem;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 6px;
        background: rgba(255, 255, 255, 0.1);
        color: #ffffff;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: center;
        min-width: 80px;
      }

      .wedding-meal-option:hover {
        background: rgba(255, 255, 255, 0.2);
        border-color: rgba(255, 255, 255, 0.5);
      }

      .wedding-meal-option.is-active {
        background: rgba(64, 224, 182, 0.3);
        border-color: #40e0b6;
        color: #40e0b6;
      }

      .wedding-meal-option[data-meal="0"].is-active {
        background: rgba(255, 107, 107, 0.3);
        border-color: #ff6b6b;
        color: #ff6b6b;
      }

      .wedding-meal-option:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .whatsapp-bubble {
        text-align: center;
        margin: 1.5rem 0;
      }

      .whatsapp-bubble--top-right {
        position: absolute;
        top: 1rem;
        right: 1rem;
        margin: 0;
        z-index: 10;
      }

      .whatsapp-bubble--top-right .whatsapp-link {
        font-size: 0.9rem;
        padding: 0.6rem 1.2rem;
      }

      .whatsapp-link {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        background: linear-gradient(120deg, #25d366, #128c7e);
        color: #ffffff;
        text-decoration: none;
        border-radius: 25px;
        font-weight: 600;
        font-size: 1rem;
        box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .whatsapp-link:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(37, 211, 102, 0.4);
        text-decoration: none;
        color: #ffffff;
      }

      .whatsapp-icon {
        font-size: 1.2rem;
      }

      /* Admin Section Styles */

      .admin-controls {

        display: flex;

        justify-content: space-between;

        align-items: center;

        margin-bottom: 1rem;

        padding: 1rem;

        background: rgba(255, 255, 255, 0.1);

        border-radius: 8px;

      }



      .admin-stats {

        display: grid;

        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));

        gap: 1rem;

        margin: 1.5rem 0;

      }



      .admin-stat-card {

        background: rgba(255, 255, 255, 0.18);

        border-radius: 12px;

        padding: 1rem;

        backdrop-filter: blur(6px);

        border: 1px solid rgba(255, 255, 255, 0.2);

        box-shadow: 0 12px 24px rgba(24, 18, 43, 0.18);

        display: flex;

        flex-direction: column;

        gap: 0.35rem;

        min-height: 200px;

      }



      .admin-stat-label {

        font-size: 0.9rem;

        font-weight: 600;

        text-transform: uppercase;

        letter-spacing: 0.05em;

        color: rgba(43, 29, 66, 0.85);

      }



      .admin-stat-value {

        margin-top: auto;

        align-self: flex-end;

        text-align: right;

        font-size: 1.8rem;

        font-weight: 700;

        color: #2b1d42;

      }



      .admin-stat-breakdown {

        display: flex;

        flex-direction: column;

        gap: 0.25rem;

        margin-top: 0.5rem;

      }



      .admin-stat-breakdown .admin-stat-subtext {

        font-size: 0.75rem;

        color: rgba(43, 29, 66, 0.85);

        display: flex;

        justify-content: space-between;

        align-items: center;

      }



      .admin-stat-breakdown .admin-stat-subtext span {

        font-weight: 600;

        color: #2b1d42;

      }



      .admin-stat-subtext {

        font-size: 0.75rem;

        color: rgba(43, 29, 66, 0.75);

      }



      .admin-table-container {


        width: 100%;

        background: rgba(255, 255, 255, 0.05);

        border-radius: 12px;

        padding: 1rem;

      }



      .admin-table-scroll {

        max-height: 500px;

        overflow: auto;

        background: rgba(255, 255, 255, 0.9);

        border-radius: 12px;

        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);

      }



      .admin-table {

        width: 100%;

        border-collapse: collapse;

        font-size: 0.85rem;

        min-width: 960px;

      }



      .admin-table thead th {

        position: sticky;

        top: 0;

        background: linear-gradient(120deg, rgba(109, 92, 231, 0.9), rgba(24, 18, 43, 0.95));

        color: white;

        padding: 0.75rem 0.5rem;

        text-align: left;

        font-weight: 600;

        border-bottom: 2px solid rgba(255, 255, 255, 0.2);

        box-shadow: inset 0 -1px 0 rgba(255, 255, 255, 0.15);

        z-index: 2;

      }



      .admin-table thead th:first-child {

        border-top-left-radius: 12px;

      }



      .admin-table thead th:last-child {

        border-top-right-radius: 12px;

      }



      .admin-table tbody tr {

        background: rgba(255, 255, 255, 0.85);

        transition: background 0.2s ease;

      }



      .admin-table td {

        padding: 0.5rem;

        border-bottom: 1px solid rgba(0, 0, 0, 0.1);

        vertical-align: top;

      }



      .admin-table tbody tr:nth-child(even) {

        background: rgba(109, 92, 231, 0.05);

      }



      .admin-table tbody tr:hover {

        background: rgba(109, 92, 231, 0.1);

      }



      .admin-table .family-group {

        background: rgba(24, 18, 43, 0.1) !important;

        border-top: 2px solid rgba(24, 18, 43, 0.3);

      }



      .admin-table .family-group:first-child {

        border-top: none;

      }



      .admin-table .family-header {

        background: rgba(24, 18, 43, 0.15) !important;

        font-weight: bold;

        color: rgba(24, 18, 43, 0.9);

      }



      .admin-table input, .admin-table select, .admin-table textarea {

        width: 100%;

        padding: 0.25rem;

        border: 1px solid rgba(0, 0, 0, 0.2);

        border-radius: 4px;

        font-size: 0.8rem;

        background: white;

      }



      .admin-table input:focus, .admin-table select:focus, .admin-table textarea:focus {

        outline: none;

        border-color: rgba(109, 92, 231, 0.5);

        box-shadow: 0 0 0 2px rgba(109, 92, 231, 0.2);

      }

      /* Color-coding for dropdown values */
      .admin-table select.value--2,
      .admin-table select.value-0 {
        background-color: #ffebee !important; /* Light red background */
        color: #c62828 !important; /* Dark red text */
      }

      .admin-table select.value--1 {
        background-color: #fff8e1 !important; /* Light yellow background */
        color: #f57f17 !important; /* Dark yellow text */
      }

      .admin-table select.value-1,
      .admin-table select.value-2,
      .admin-table select.value-3,
      .admin-table select.value-4,
      .admin-table select.value-5 {
        background-color: #e8f5e8 !important; /* Light green background */
        color: #2e7d32 !important; /* Dark green text */
      }

      .admin-table .guest-id {

        cursor: pointer;

        color: #ffffff;

        background: linear-gradient(120deg, rgba(109, 92, 231, 0.9), rgba(24, 18, 43, 0.95));

        padding: 0.25rem 0.75rem;

        border-radius: 6px;

        font-size: 0.85rem;

        font-weight: 600;

        text-align: center;

        display: inline-block;

        transition: all 0.2s ease;

        border: 1px solid rgba(109, 92, 231, 0.3);

      }



      .admin-table .guest-id:hover {

        background: linear-gradient(120deg, rgba(24, 18, 43, 0.95), rgba(109, 92, 231, 0.9));

        transform: translateY(-1px);

        box-shadow: 0 2px 8px rgba(109, 92, 231, 0.3);

      }



      .admin-table .loading {

        text-align: center;

        padding: 2rem;

        color: rgba(24, 18, 43, 0.7);

        font-style: italic;

      }



      /* Guest Link Popup */

      .guest-popup {

        position: fixed;

        top: 0;

        left: 0;

        width: 100%;

        height: 100%;

        background: rgba(0, 0, 0, 0.8);

        display: flex;

        align-items: center;

        justify-content: center;

        z-index: 10000;

      }



      .guest-popup-content {

        background: white;

        padding: 2rem;

        border-radius: 12px;

        max-width: 600px;

        width: 90%;

        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);

        color: #333;

        line-height: 1.6;

      }



      .guest-popup h3 {

        margin-top: 0;

        color: rgba(24, 18, 43, 0.9);

      }



      .guest-popup .guest-link {

        display: block;

        padding: 1rem;

        background: rgba(109, 92, 231, 0.1);

        border: 1px solid rgba(109, 92, 231, 0.3);

        border-radius: 8px;

        margin: 1rem 0;

        word-break: break-all;

        font-family: monospace;

        font-size: 0.9rem;

        color: #6d5ce7;

        text-decoration: none;

      }



      .guest-popup .guest-link:hover {

        background: rgba(109, 92, 231, 0.2);

        text-decoration: underline;

      }



      .guest-popup .close-btn {

        background: rgba(255, 99, 132, 0.9);

        color: white;

        border: none;

        padding: 0.5rem 1rem;

        border-radius: 6px;

        cursor: pointer;

        float: right;

      }



      .guest-popup .close-btn:hover {

        background: rgba(199, 35, 78, 0.95);

      }

    </style>

  </head>

  <body>

    <header class="hero" style="--hero-image: url('{{ url_for('static', filename='images/hero.jpg') }}');">

      <div class="content">

        <div class="hero-actions">

            <p>
            <a href="https://www.quobpark.com/" target="_blank" rel="noopener">
              <button type="button" style="padding: 0.5em 1.2em; font-size: 1rem; border-radius: 999px; border: none; background: linear-gradient(120deg, #ffd6ff 80%, #6d5ce7 100%); color: #12082c; font-weight: 600; cursor: pointer;">
              Saturday 12 September 2026 - Quob Park
              </button>
            </a>
            </p></a>

          <h1>James & Heather's Wedding Weekend</h1>

          <p>Here's the working itinerary for our wedding celebration. We'll keep this page updated as plans lock in.</p>

          <div id="family-section" class="hidden">

            <div class="attendance-toggle" id="attendance-toggle">

              <button class="attendance-button attendance-button--yes" type="button" data-status="1">Attending</button>

              <button class="attendance-button attendance-button--no" type="button" data-status="0">Not attending</button>

            </div>

          </div>

          <div id="public-section">

            <form class="hero-rsvp" novalidate>

              <label class="sr-only" for="family-code">Family code</label>

              <input id="family-code" name="family_code" type="text" inputmode="text" maxlength="4" placeholder="Enter family code" autocomplete="off" required>

              <button class="rsvp-button" type="submit">View Details</button>

            </form>

          </div>

        </div>

        </div>

      </div>

    </header>



    <main>

      <ul class="timeline">

        <li id="admin-section" class="section admin-section hidden" style="--section-image: url('{{ url_for('static', filename='images/admin.jpg') }}');">

          <div class="inner-full"> 

            <h2>Admin Section</h2>

            <div class="admin-stats" id="admin-stat-cards">

              <div class="admin-stat-card">
                <div class="admin-stat-label">Stag</div>
                <div class="admin-stat-subtext">Attending / Invited</div>
                <div class="admin-stat-value" id="stat-stag">0 / 0</div>
              </div>

              <div class="admin-stat-card">
                <div class="admin-stat-label">Hen</div>
                <div class="admin-stat-subtext">Attending / Invited</div>
                <div class="admin-stat-value" id="stat-hen">0 / 0</div>
              </div>

              <div class="admin-stat-card">
                <div class="admin-stat-label">Friday Room</div>
                <div class="admin-stat-breakdown">
                  <div class="admin-stat-subtext">Attending: <span id="stat-friday_room-attending">0</span></div>
                  <div class="admin-stat-subtext">Invited: <span id="stat-friday_room-invited">0</span></div>
                  <div class="admin-stat-subtext">New Place: <span id="stat-friday_room-newplace">0</span></div>
                  <div class="admin-stat-subtext">Quab Park: <span id="stat-friday_room-quabpark">0</span></div>
                </div>
              </div>

              <div class="admin-stat-card">
                <div class="admin-stat-label">Attendance Status</div>
                <div class="admin-stat-subtext">Attending / Invited</div>
                <div class="admin-stat-value" id="stat-attendance_status">0 / 0</div>
              </div>

              <div class="admin-stat-card">
                <div class="admin-stat-label">Ceremony</div>
                <div class="admin-stat-subtext">Attending / Invited</div>
                <div class="admin-stat-value" id="stat-ceremony">0 / 0</div>
              </div>

              <div class="admin-stat-card">
                <div class="admin-stat-label">Wedding Meal</div>
                <div class="admin-stat-breakdown">
                  <div class="admin-stat-subtext">Attending: <span id="stat-wedding_meal-attending">0</span></div>
                  <div class="admin-stat-subtext">Invited: <span id="stat-wedding_meal-invited">0</span></div>
                  <div class="admin-stat-subtext">Beef: <span id="stat-wedding_meal-beef">0</span></div>
                  <div class="admin-stat-subtext">Fish: <span id="stat-wedding_meal-fish">0</span></div>
                  <div class="admin-stat-subtext">Vegetarian: <span id="stat-wedding_meal-vegetarian">0</span></div>
                </div>
              </div>

              <div class="admin-stat-card">
                <div class="admin-stat-label">Saturday Room</div>
                <div class="admin-stat-breakdown">
                  <div class="admin-stat-subtext">Attending: <span id="stat-saturday_room-attending">0</span></div>
                  <div class="admin-stat-subtext">Invited: <span id="stat-saturday_room-invited">0</span></div>
                  <div class="admin-stat-subtext">New Place: <span id="stat-saturday_room-newplace">0</span></div>
                  <div class="admin-stat-subtext">Quab Park: <span id="stat-saturday_room-quabpark">0</span></div>
                  <div class="admin-stat-subtext">Quab Estate: <span id="stat-saturday_room-quabestate">0</span></div>
                </div>
              </div>

            </div>

            <div class="admin-table-container">

              <div class="admin-table-scroll">

                <table id="admin-guest-table" class="admin-table">

                  <thead>

                    <tr>

                      <th><i class="fas fa-cog" style="font-size: 1.2em;"></i></th>

                      <th>Name</th>

                      <th>Stag</th>

                      <th>Hen</th>

                      <th>Friday Room</th>

                      <th>Ceremony</th>

                      <th>Attendance Status</th>

                      <th>Wedding Meal</th>

                      <th>Saturday Room</th>

                    </tr>

                  </thead>

                  <tbody id="admin-table-body">

                    <tr>

                      <td colspan="9" class="loading">Loading guest data...</td>

                    </tr>

                  </tbody>

                </table>

              </div>

            </div>

            <div class="admin-table-container">
              <h3>Recent Changes</h3>
              <div id="change-log-body" style="background: rgba(255, 255, 255, 0.9); border-radius: 12px; padding: 1rem; max-height: 400px; overflow-y: auto; color: black;">
                <div class="loading">Loading change log...</div>
              </div>
            </div>

          </div>

        </li>

        <li id="stag-section" class="section hidden" style="--section-image: url('{{ url_for('static', filename='images/stag.jpg') }}');">

          <div class="inner">

            <div class="whatsapp-bubble whatsapp-bubble--top-right">
              <a href="https://chat.whatsapp.com/BI51UKUcHJtLho8yVLaAQo" target="_blank" rel="noopener" class="whatsapp-link">
                <span class="whatsapp-icon">ðŸ“±</span>
                Join Stag WhatsApp Group
              </a>
            </div>

            <h2>Stag Adventure</h2>

            <p class="note">Detailed plans will drop about two months before the wedding. Expect an outdoorsy afternoon with a hearty feast to follow.</p>

            <p>We'll share timings, meeting point, and kit list as soon as venues confirm availability. A group message will go out once everything is booked.</p>

            <div class="stag-selection" id="stag-selection">
              <h3>RSVP for Stag Adventure</h3>
              <div id="stag-guests" class="stag-guests">
                <!-- Individual guest stag selections will be populated here -->
              </div>
            </div>

            <div class="stag-names" id="stag-names">
              <h3>Who's Coming:</h3>
              <div id="stag-names-list"></div>
            </div>

            <div class="stag-ideas">
              <h3>Stag Ideas:</h3>
              <textarea id="stag-ideas-text" placeholder="Share your stag adventure ideas here..." rows="3"></textarea>
            </div>

            <div class="stag-ai-suggestions" id="stag-ai-suggestions" style="display: none;">
              <h3>AI Suggestions:</h3>
              <div id="stag-ai-content" class="ai-suggestions-content">
                Loading suggestions...
              </div>
            </div>

          </div>

        </li>



        <li id="hen-section" class="section hidden" style="--section-image: url('{{ url_for('static', filename='images/hen.jpg') }}');">

          <div class="inner">

            <div class="whatsapp-bubble whatsapp-bubble--top-right">
              <a href="https://chat.whatsapp.com/KKFD5tVsRfGKnMspqhhLqD" target="_blank" rel="noopener" class="whatsapp-link">
                <span class="whatsapp-icon">ðŸ“±</span>
                Join Hen WhatsApp Group
              </a>
            </div>

            <h2>Hen Gathering</h2>

            <p class="note">Heather is shaping the perfect calm-before-the-celebration day. Finalised details will arrive around the two-month mark.</p>

            <p>Plan on relaxed pampering, something floral, and golden hour cocktails. We'll publish the full itinerary and RSVP info soon.</p>

            <div class="hen-selection" id="hen-selection">
              <h3>RSVP for Hen Gathering</h3>
              <div id="hen-guests" class="hen-guests">
                <!-- Individual guest hen selections will be populated here -->
              </div>
            </div>

            <div class="hen-names" id="hen-names">
              <h3>Who's Coming:</h3>
              <div id="hen-names-list"></div>
            </div>

            <div class="hen-ideas">
              <h3>Hen Ideas:</h3>
              <textarea id="hen-ideas-text" placeholder="Share your hen gathering ideas here..." rows="3"></textarea>
            </div>

            <div class="hen-ai-suggestions" id="hen-ai-suggestions" style="display: none;">
              <h3>AI Suggestions:</h3>
              <div id="hen-ai-content" class="ai-suggestions-content">
                Loading suggestions...
              </div>
            </div>

          </div>

        </li>



        <li id="friday-section" class="section" style="--section-image: url('{{ url_for('static', filename='images/friday-stay.webp') }}');">

          <div class="inner">

            <h2>Friday Night Stay</h2>

            <p>Settle in, meet the crew, and ease into the weekend.</p>

            <ul class="schedule">

              <li class="schedule-item">

                <time>14:00</time>

                <p>Guest check-in. Drop bags, explore the grounds, and claim your room.</p>

              </li>

              <li class="schedule-item">

                <time>17:00</time>

                <p>Welcome drinks on the terrace with small bites and acoustic covers.</p>

              </li>

              <li class="schedule-item">

                <time>19:00</time>

                <p>Casual dinner featuring wood-fired pizza, salads, and relaxed lawn games into the evening.</p>

              </li>

            </ul>

            <!-- Friday Night Stay Options -->
            <div class="stay-options">
              <h3>Choose Your Friday Night Accommodation</h3>
              <div class="stay-cards">
                <div class="stay-card" data-option="2">
                  <div class="stay-card-header">
                    <h4>New Place Hotel</h4>
                    <span class="stay-address">Shirrell Heath, Southampton SO32 2JY</span>
                  </div>
                  <div class="stay-card-content">
                    <p>Comfortable accommodations in a convenient location with easy access to the wedding venue.</p>
                  </div>
                  <div class="stay-card-actions">
                    <a href="https://maps.app.goo.gl/K7Fs4aTNEL4SNhiQ7" target="_blank" class="map-link">View on Maps</a>
                    <button class="stay-select-btn" data-option="2" data-day="friday">Select This Option</button>
                  </div>
                </div>
                
                <div class="stay-card" data-option="3">
                  <div class="stay-card-header">
                    <h4>Quob Park Old House Hotel & Spa</h4>
                    <span class="stay-address">The Square, Wickham, Fareham PO17 5JG</span>
                  </div>
                  <div class="stay-card-content">
                    <p>Historic hotel with spa facilities for a luxurious and relaxing stay.</p>
                  </div>
                  <div class="stay-card-actions">
                    <a href="https://maps.app.goo.gl/NGywh41ocL2GK8NaA" target="_blank" class="map-link">View on Maps</a>
                    <button class="stay-select-btn" data-option="3" data-day="friday">Select This Option</button>
                  </div>
                </div>
              </div>
            </div>

          </div>

        </li>



        <li class="section" style="--section-image: url('{{ url_for('static', filename='images/ceremony.jpg') }}');">

          <div class="inner">

            <h2>Formal Ceremony</h2>

            <p>We'll say "I do" in the oak meadow, then celebrate with bubbles and canapes.</p>

            <div class="ceremony-selection" id="ceremony-selection">
              <h3>RSVP for Formal Ceremony</h3>
              <div id="ceremony-guests" class="ceremony-guests">
                <!-- Individual guest ceremony selections will be populated here -->
              </div>
            </div>

            <div class="ceremony-names" id="ceremony-names">
              <h3>Who's Attending the Ceremony:</h3>
              <div id="ceremony-names-list"></div>
            </div>

            <ul class="schedule">

              <li class="schedule-item">

                <time>14:00</time>

                <p>Formal ceremony under the pergola. Please be seated by 13:45.</p>

              </li>

              <li class="schedule-item">

                <time>15:45</time>

                <p>Confetti toss followed by canapes (4pp) with cocktails and sparkling as meal guests arrive.</p>

              </li>

            </ul>

          </div>

        </li>



        <li class="section" style="--section-image: url('{{ url_for('static', filename='images/wedding-meal.jpg') }}');">

          <div class="inner">

            <h2>Wedding Meal</h2>

            <p>A gourmet 3-course wedding breakfast at Wine &amp; Pairings with carefully matched vintages.</p>

            <ul class="schedule">

              <li class="schedule-item">

                <time>17:00</time>

                <p>Take your seats, pour the first glass, and enjoy the opening course.</p>

              </li>

              <li class="schedule-item">

                <time>18:40</time>

                <p>Toasts and prayers between courses - short, sweet, and celebratory.</p>

              </li>

            </ul>

            <div class="wedding-meal-selection" id="wedding-meal-selection">
              <h3>Select Your Meal Preference</h3>
              <div id="wedding-meal-guests" class="wedding-meal-guests">
                <!-- Guest meal selections will be populated here -->
              </div>
            </div>

          </div>

        </li>



        <li class="section" style="--section-image: url('{{ url_for('static', filename='images/entertainment.jpg') }}');">

          <div class="inner">

            <h2>Entertainment</h2>

            <p>Beard are here to rock and roll, bringing indie anthems and party classics. A late-night DJ set keeps the dance floor alive until the grand exit.</p>

            <div class="band-highlight">

              <p><strong>Live Band:</strong> <a href="https://www.instagram.com/beardbanduk" target="_blank" rel="noopener">@beardbanduk</a> - 169 posts - 350 followers - 377 following. Available for bookings via <a href="https://www.facebook.com/share/1BKjEJbGak" target="_blank" rel="noopener">Facebook</a>.</p>

              <p><strong>Evening Flow:</strong> Party kicks off 18:20 with Beard's first set, DJ takeover from 22:30 mixing crowd requests until 23:30.</p>

            </div>

            <ul class="schedule">

              <li class="schedule-item">

                <time>18:20</time>

                <p>Party Time! Live band set, photo booth fun, and lawn games under the festoon lights.</p>

              </li>

              <li class="schedule-item">

                <time>18:30</time>

                <p>Laid-back BBQ and salad bar, acoustic set by the fire, and cosy blankets.</p>

              </li>
              <li class="schedule-item">

                <time>21:00</time>

                <p>Cut the cake, refill the glasses, and transition to the DJ's high-energy mix.</p>

              </li>


              <li class="schedule-item">

                <time>23:30</time>

                <p>Grand exit with sparklers and a final slow dance before the after-hours playlist.</p>

              </li>

            </ul>



            <div class="insta-grid" id="instagram-feed" aria-live="polite"></div>

            <div class="upcoming-events">
              <h3>Upcoming BEARD Events:</h3>
              <div id="facebook-events" aria-live="polite">
                <div class="loading">Loading upcoming events...</div>
              </div>
            </div>

            <div class="music-requests">
              <h3>Song Requests & Special Requests:</h3>
              <textarea id="music-requests-text" placeholder="Let us know your favourite songs or any special requests for the evening..." rows="3"></textarea>
            </div>

          </div>

        </li>



        <li id="saturday-section" class="section" style="--section-image: url('{{ url_for('static', filename='images/saturday-stay.jpg') }}');">

          <div class="inner">

            <h2>Saturday Night Stay</h2>

            <p>Wind down with a relaxed BBQ, marshmallow toasting, and stargazing. Sunday morning wraps with a slow brunch and heartfelt goodbyes.</p>

            <ul class="schedule">


              <li class="schedule-item">

                <time>09:30</time>

                <p>Breakfast on Sunday with pastries, fresh fruit, and barista coffee.</p>

              </li>

              <li class="schedule-item">

                <time>11:00</time>

                <p>Check-out and farewell hugs - safe travels and see you soon.</p>

              </li>

            </ul>

            <!-- Saturday Night Stay Options -->
            <div class="stay-options">
              <h3>Choose Your Saturday Night Accommodation</h3>
              <div class="stay-cards">
                <div class="stay-card" data-option="2">
                  <div class="stay-card-header">
                    <h4>New Place Hotel</h4>
                    <span class="stay-address">Shirrell Heath, Southampton SO32 2JY</span>
                  </div>
                  <div class="stay-card-content">
                    <p>Comfortable accommodations in a convenient location with easy access to the wedding venue.</p>
                  </div>
                  <div class="stay-card-actions">
                    <a href="https://maps.app.goo.gl/K7Fs4aTNEL4SNhiQ7" target="_blank" class="map-link">View on Maps</a>
                    <button class="stay-select-btn" data-option="2" data-day="saturday">Select This Option</button>
                  </div>
                </div>
                
                <div class="stay-card" data-option="3">
                  <div class="stay-card-header">
                    <h4>Quob Park Old House Hotel & Spa</h4>
                    <span class="stay-address">The Square, Wickham, Fareham PO17 5JG</span>
                  </div>
                  <div class="stay-card-content">
                    <p>Historic hotel with spa facilities for a luxurious and relaxing stay.</p>
                  </div>
                  <div class="stay-card-actions">
                    <a href="https://maps.app.goo.gl/NGywh41ocL2GK8NaA" target="_blank" class="map-link">View on Maps</a>
                    <button class="stay-select-btn" data-option="3" data-day="saturday">Select This Option</button>
                  </div>
                </div>

                <div class="stay-card" data-option="4">
                  <div class="stay-card-header">
                    <h4>Quob Park Estate</h4>
                    <span class="stay-address">Titchfield Ln, Wickham, Fareham PO17 5PG</span>
                  </div>
                  <div class="stay-card-content">
                    <p>Beautiful estate setting with extensive grounds for a unique and memorable experience.</p>
                  </div>
                  <div class="stay-card-actions">
                    <a href="https://maps.app.goo.gl/qto1K3TgckxQVmoa6" target="_blank" class="map-link">View on Maps</a>
                    <button class="stay-select-btn" data-option="4" data-day="saturday">Select This Option</button>
                  </div>
                </div>
              </div>
            </div>

          </div>

        </li>

      </ul>



      <div id="additional-guests" class="hidden">

        <h2>Additional Guest Information</h2>

        <div id="no-family-guests" class="hidden">

          <h3>Guests Without Family Code</h3>

          <ul id="no-family-list"></ul>

        </div>

        <div id="all-guests" class="hidden">

          <h3>All Guests</h3>

          <ul id="all-guests-list"></ul>

        </div>

      </div>

    </main>



    <script>

      let currentFamilyCode = null;

      let familyData = null;

      let noFamilyGuests = null;

      let allGuests = null;



      // Ensure all functions are defined before use

      function ensureFunctionsReady() {

        const requiredFunctions = ['showElement', 'hideElement', 'showToast', 'displayGuests', 'updateAdditionalGuestsSection', 'updateFamilySection', 'loadFamilyData', 'getFamilyCodeFromURL'];

        const missing = [];

        for (const fn of requiredFunctions) {

          const isFunction = typeof window[fn] === 'function' || typeof globalThis[fn] === 'function';

          console.log(`${fn}: ${isFunction ? 'defined' : 'NOT defined'}`);

          if (!isFunction) {

            missing.push(fn);

          }

        }

        if (missing.length > 0) {

          console.error('Missing functions:', missing);

          return false;

        }

        console.log('All functions are ready!');

        return true;

      }



      function showElement(id) {

        const el = document.getElementById(id);

        if (el) el.classList.remove('hidden');

      }



      function hideElement(id) {

        const el = document.getElementById(id);

        if (el) el.classList.add('hidden');

      }



      function showToast(message, type = 'success') {

        // Remove existing toast

        const existingToast = document.querySelector('.toast');

        if (existingToast) {

          existingToast.remove();

        }



        // Create new toast

        const toast = document.createElement('div');

        toast.className = `toast toast--${type}`;

        toast.textContent = message;

        document.body.appendChild(toast);



        // Show toast

        setTimeout(() => toast.classList.add('toast--visible'), 10);



        // Hide toast after 3 seconds

        setTimeout(() => {

          toast.classList.remove('toast--visible');

          setTimeout(() => toast.remove(), 300);

        }, 3000);

      }



      function displayGuests(guests, listElementId) {

        console.log('displayGuests function called');

        console.log('displayGuests is defined:', typeof displayGuests);

        console.log('Arguments:', guests, listElementId);

        const list = document.getElementById(listElementId);

        if (!list) {

          console.error('List element not found:', listElementId);

          return;

        }



        list.innerHTML = '';

        if (!guests || !Array.isArray(guests)) {

          console.warn('Invalid guests data:', guests);

          return;

        }



        guests.forEach(guest => {

          const li = document.createElement('li');

          li.textContent = `${guest.name} (${guest.family_id || 'No family'})`;

          list.appendChild(li);

        });

        console.log('displayGuests completed successfully');

      }



      function updateAdditionalGuestsSection() {

        console.log('updateAdditionalGuestsSection called');

        console.log('noFamilyGuests:', noFamilyGuests);

        console.log('allGuests:', allGuests);

        console.log('displayGuests function:', typeof displayGuests);



        const section = document.getElementById('additional-guests');

        const noFamilyDiv = document.getElementById('no-family-guests');

        const allGuestsDiv = document.getElementById('all-guests');



        if ((noFamilyGuests && noFamilyGuests.length > 0) || (allGuests && allGuests.length > 0)) {

          // Keep debugging section hidden - commented out for production
          // showElement('additional-guests');

          

          if (noFamilyGuests && noFamilyGuests.length > 0) {

            showElement('no-family-guests');

            if (typeof displayGuests === 'function') {

              displayGuests(noFamilyGuests, 'no-family-list');

            } else {

              console.error('displayGuests is not a function when trying to display noFamilyGuests');

            }

          } else {

            hideElement('no-family-guests');

          }

          

          if (allGuests && allGuests.length > 0) {

            showElement('all-guests');

            if (typeof displayGuests === 'function') {

              displayGuests(allGuests, 'all-guests-list');

            } else {

              console.error('displayGuests is not a function when trying to display allGuests');

            }

          } else {

            hideElement('all-guests');

          }

        } else {

          hideElement('additional-guests');

        }

      }



      function updateFamilySection() {

        console.log('updateFamilySection called');

        console.log('familyData:', familyData);

        console.log('currentFamilyCode:', currentFamilyCode);

        const toggle = document.getElementById('attendance-toggle');



        if (!familyData || !currentFamilyCode) {

          console.log('Hiding family-section, showing public-section, hiding admin-section');

          hideElement('family-section');

          showElement('public-section');

          hideElement('admin-section');

          hideElement('stag-section');

          hideElement('hen-section');

          // Friday and Saturday sections should always be visible
          // hideElement('friday-section');
          // hideElement('saturday-section');

          return;

        }



        console.log('Showing family-section, hiding public-section');

        showElement('family-section');

        hideElement('public-section');



        // Show admin section only for LAMP family code

        if (currentFamilyCode && currentFamilyCode.toUpperCase() === 'LAMP') {

          console.log('Showing admin section for LAMP family code');

          showElement('admin-section');

          // Initialize admin functionality when section becomes visible

          setTimeout(() => initializeAdminSection(), 100);

        } else {

          console.log('Hiding admin section (not LAMP code)');

          hideElement('admin-section');

        }



        // Show stag section if any family member has stag >= -1 (invited or attending)

        const hasStag = familyData.some(guest => {

          const stagValue = guest.stag;

          return stagValue !== null && stagValue !== undefined && stagValue !== '' && parseInt(stagValue, 10) >= -1;

        });

        if (hasStag) {

          console.log('Showing stag section');

          showElement('stag-section');

        } else {

          console.log('Hiding stag section');

          hideElement('stag-section');

        }



        // Show hen section if any family member has hen >= -1 (invited or attending)

        const hasHen = familyData.some(guest => {

          const henValue = guest.hen;

          return henValue !== null && henValue !== undefined && henValue !== '' && parseInt(henValue, 10) >= -1;

        });

        if (hasHen) {

          console.log('Showing hen section');

          showElement('hen-section');

        } else {

          console.log('Hiding hen section');

          hideElement('hen-section');

        }



        // Friday section should always be visible
        console.log('Showing friday section');
        showElement('friday-section');



        // Saturday section should always be visible
        console.log('Showing saturday section');
        showElement('saturday-section');



        toggle.dataset.familyCode = currentFamilyCode;



        // Set active state based on attendance

        const statuses = familyData.map(guest => guest.attendance_status).filter(s => s !== null);

        const yesBtn = toggle.querySelector('[data-status="1"]');

        const noBtn = toggle.querySelector('[data-status="0"]');



        if (statuses.includes(1)) {

          yesBtn.classList.add('is-active');

          noBtn.classList.remove('is-active');

        } else if (statuses.includes(0)) {

          noBtn.classList.add('is-active');

          yesBtn.classList.remove('is-active');

        } else {

          yesBtn.classList.remove('is-active');

          noBtn.classList.remove('is-active');

        }



        // Update stag and hen names display

        updateStagHenCeremonyNames();

        // Update individual guest selections

        updateStagGuests();

        updateHenGuests();

        updateCeremonyGuests();

        // Update wedding meal guests

        updateWeddingMealGuests();

      }

      function populateTextAreas() {
        console.log('=== populateTextAreas() called ===');
        if (!familyData || familyData.length === 0) {
          console.log('No family data available for populateTextAreas');
          return;
        }

        // Find the main guest (first adult, or groom/bride, or first guest as fallback)
        let mainGuest = familyData.find(guest => guest.guest_type === 'Groom') ||
                       familyData.find(guest => guest.guest_type === 'Bride') ||
                       familyData.find(guest => guest.age === 'Adult') ||
                       familyData[0];

        console.log('Main guest data for text areas:', mainGuest);

        // Load stag_ideas from main guest
        if (mainGuest.stag_ideas) {
          const stagTextarea = document.getElementById('stag-ideas-text');
          if (stagTextarea) {
            console.log('Loading stag_ideas:', mainGuest.stag_ideas);
            stagTextarea.value = mainGuest.stag_ideas;
          }
        }

        // Load hen_ideas from main guest
        if (mainGuest.hen_ideas) {
          const henTextarea = document.getElementById('hen-ideas-text');
          if (henTextarea) {
            console.log('Loading hen_ideas:', mainGuest.hen_ideas);
            henTextarea.value = mainGuest.hen_ideas;
          }
        }

        // Load music_requests from main guest - check for any value including empty string
        const musicTextarea = document.getElementById('music-requests-text');
        if (musicTextarea) {
          if (mainGuest.music_requests !== null && mainGuest.music_requests !== undefined) {
            console.log('Loading music_requests:', mainGuest.music_requests);
            musicTextarea.value = mainGuest.music_requests;
          } else {
            console.log('No music_requests found for main guest (null/undefined):', mainGuest.music_requests);
            musicTextarea.value = ''; // Clear the field
          }
        } else {
          console.log('Music textarea element not found!');
        }
      }



      async function loadFamilyData(code) {

        // Reset data

        familyData = null;

        noFamilyGuests = null;

        allGuests = null;

        updateFamilySection();

        if (typeof updateAdditionalGuestsSection === 'function') {

          updateAdditionalGuestsSection();

        }



        try {

          const response = await fetch(`/api/guests/family/${code}`);

          if (!response.ok) {

            if (response.status === 404) {

              throw new Error('We couldn\'t find that family code. Check your invite and try again.');

            }

            throw new Error('We couldn\'t load the guest list right now. Please try again shortly.');

          }

          const data = await response.json();

          familyData = data.data;

          currentFamilyCode = code;

          console.log('Family data loaded successfully');

          console.log('familyData:', familyData);

          console.log('currentFamilyCode:', currentFamilyCode);

          

          // Debug: Check first guest data specifically
          if (familyData && familyData.length > 0) {
            console.log('First guest in familyData:', familyData[0]);
            console.log('First guest music_requests:', familyData[0].music_requests);
          }

          

          // Save family code to cookie for future visits

          saveFamilyCodeToCookie(code);

          

          updateFamilySection();

          // Populate text areas with existing data
          populateTextAreas();
          // Update stay preferences UI
          updateStayPreferences();

          // Load ALL guests for stag/hen sections
          try {
            const allGuestsResponse = await fetch('/api/guests');
            if (allGuestsResponse.ok) {
              const allGuestsData = await allGuestsResponse.json();
              allGuests = allGuestsData.data;
              console.log('All guests loaded successfully:', allGuests.length, 'guests');
              
              // Update stag/hen sections now that we have all guest data
              updateStagGuests();
              updateHenGuests();
              updateStagHenCeremonyNames();
            }
          } catch (error) {
            console.error('Failed to load all guests', error);
          }

          // If we got family data, also fetch guests without family

          if (familyData && familyData.length > 0) {

            try {

              const noFamilyResponse = await fetch('/api/guests/no-family');

              if (noFamilyResponse.ok) {

                const noFamilyData = await noFamilyResponse.json();

                noFamilyGuests = noFamilyData.data;

                if (typeof updateAdditionalGuestsSection === 'function') {

                  updateAdditionalGuestsSection();

                }

              }

            } catch (error) {

              console.error('Failed to load no-family guests', error);

            }

          }





          if (typeof updateAdditionalGuestsSection === 'function') {

            updateAdditionalGuestsSection();

          }

        } catch (error) {

          console.error('Failed to load family data', error);

          familyData = null;

          currentFamilyCode = null;

          noFamilyGuests = null;

          allGuests = null;

          updateFamilySection();

          if (typeof updateAdditionalGuestsSection === 'function') {

            updateAdditionalGuestsSection();

          }

        }

      }



      function getFamilyCodeFromURL() {

        const urlParams = new URLSearchParams(window.location.search);

        return urlParams.get('family_code');

      }



      function saveFamilyCodeToCookie(code) {

        if (code) {

          // Save for 30 days

          const expiryDate = new Date();

          expiryDate.setDate(expiryDate.getDate() + 30);

          document.cookie = `family_code=${code.toUpperCase()}; expires=${expiryDate.toUTCString()}; path=/; SameSite=Lax`;

        }

      }



      function getFamilyCodeFromCookie() {

        const cookies = document.cookie.split(';');

        for (let cookie of cookies) {

          const [name, value] = cookie.trim().split('=');

          if (name === 'family_code') {

            return value;

          }

        }

        return null;

      }



      // On page load

      if (ensureFunctionsReady()) {

        let initialCode = getFamilyCodeFromURL();

        

        // If no code in URL, try cookie

        if (!initialCode) {

          initialCode = getFamilyCodeFromCookie();

        }

        

        if (initialCode) {

          loadFamilyData(initialCode);

        } else {

          updateFamilySection();

          populateTextAreas();
          updateStayPreferences();

        }

      } else {

        console.error('Functions not ready, retrying in 100ms...');

        setTimeout(() => {

          if (ensureFunctionsReady()) {

            let initialCode = getFamilyCodeFromURL();

            

            // If no code in URL, try cookie

            if (!initialCode) {

              initialCode = getFamilyCodeFromCookie();

            }

            

            if (initialCode) {

              loadFamilyData(initialCode);

            } else {

              updateFamilySection();

              populateTextAreas();
              updateStayPreferences();

            }

          } else {

            console.error('Functions still not ready after retry');

          }

        }, 100);

      }



      const rsvpForm = document.querySelector('.hero-rsvp');

      if (rsvpForm) {

        const input = rsvpForm.querySelector('input[name="family_code"]');

        if (input) {

          input.addEventListener('input', () => {

            input.value = input.value.replace(/[^a-zA-Z0-9]/g, '').toUpperCase().slice(0, 4);

          });

        }

        rsvpForm.addEventListener('submit', (event) => {

          event.preventDefault();

          if (!input) {

            return;

          }

          const code = (input.value || '').trim().toUpperCase();

          if (code.length !== 4) {

            window.alert('Please enter your four-character family code.');

            input.focus();

            return;

          }

          loadFamilyData(code);

          // Update URL without reload

          const url = new URL(window.location);

          url.searchParams.set('family_code', code);

          window.history.pushState({}, '', url);

        });

      }



      const attendanceToggle = document.getElementById('attendance-toggle');

      if (attendanceToggle) {

        const buttons = attendanceToggle.querySelectorAll('.attendance-button');



        const setActiveState = (targetStatus) => {

          buttons.forEach((btn) => {

            const btnStatus = Number(btn.dataset.status);

            btn.classList.toggle('is-active', btnStatus === targetStatus);

          });

        };



        buttons.forEach((button) => {

          button.addEventListener('click', async () => {

            const status = Number(button.dataset.status);

            if (!currentFamilyCode || Number.isNaN(status)) {

              return;

            }



            // Store original button texts

            const originalTexts = {};

            buttons.forEach((btn) => {

              originalTexts[btn.dataset.status] = btn.textContent;

              btn.disabled = true;

              btn.textContent = 'Saving...';

            });



            console.log('Starting attendance update for status:', status);



            try {

              const response = await fetch('/api/family/attendance', {

                method: 'POST',

                headers: { 'Content-Type': 'application/json' },

                body: JSON.stringify({ family_code: currentFamilyCode, status }),

              });



              console.log('API response status:', response.status);



              if (!response.ok) {

                let message = 'Unable to update attendance right now.';

                try {

                  const payload = await response.json();

                  message = payload.description || payload.message || message;

                } catch (_) {

                  // noop

                }

                throw new Error(message);

              }



              const result = await response.json();

              console.log('API response:', result);



              // Update buttons immediately

              setActiveState(status);



              // Update local family data to reflect the change

              if (familyData) {

                familyData.forEach(guest => {

                  guest.attendance_status = status;

                });

                updateFamilySection();

              }



              // Show success toast

              showToast(`Attendance updated for ${result.updated_guests} guest${result.updated_guests !== 1 ? 's' : ''}!`);



            } catch (error) {

              console.error('Attendance update failed:', error);

              showToast(error.message || 'Could not update attendance. Please try again.', 'error');

            } finally {

              // Reset button states

              console.log('Resetting button states');

              buttons.forEach((btn) => {

                btn.disabled = false;

                const btnStatus = btn.dataset.status;

                btn.textContent = originalTexts[btnStatus] || (btnStatus === '1' ? 'Attending' : 'Not attending');

              });

            }

          });

        });

      }



      // Stag, Hen, and Ceremony Section Functionality

      function updateStagHenCeremonyNames() {
        if (!allGuests) return;

        // Update stag names - show ALL guests (not just family) with stag > -2
        const stagNamesList = document.getElementById('stag-names-list');
        if (stagNamesList) {
          const stagGuests = allGuests.filter(guest => {
            const stagValue = guest.stag;
            return stagValue !== null && stagValue !== undefined && stagValue !== '' && parseInt(stagValue, 10) > -2;
          });
          
          stagNamesList.innerHTML = stagGuests.map(guest => {
            const stagValue = guest.stag;
            let className = 'name-tag';
            
            // Color code based on stag status
            if (stagValue !== null && stagValue !== undefined && stagValue !== '' && parseInt(stagValue, 10) === 1) {
              className += ' attending';  // Green for attending
            } else if (stagValue !== null && stagValue !== undefined && stagValue !== '' && parseInt(stagValue, 10) === 0) {
              className += ' not-attending';  // Red for not attending
            } else if (stagValue !== null && stagValue !== undefined && stagValue !== '' && parseInt(stagValue, 10) === -1) {
              className += ' invited';  // Yellow for invited but no response
            } else {
              className += ' not-invited';  // Gray for not invited
            }
            
            return `<span class="${className}">${guest.name}</span>`;
          }).join('');

          // Update stag count - count only those invited and attending
          const stagHeader = document.querySelector('#stag-names h3');
          if (stagHeader) {
            const invitedStagGuests = stagGuests.filter(guest => {
              const stagValue = guest.stag;
              return stagValue !== null && stagValue !== undefined && stagValue !== '' && parseInt(stagValue, 10) >= -1;
            });
            const attendingCount = invitedStagGuests.filter(guest => parseInt(guest.stag, 10) === 1).length;
            stagHeader.textContent = `Who's Coming (${attendingCount}/${invitedStagGuests.length}):`;
          }
        }

        // Update hen names - show ALL guests (not just family) with hen > -2
        const henNamesList = document.getElementById('hen-names-list');
        if (henNamesList) {
          const henGuests = allGuests.filter(guest => {
            const henValue = guest.hen;
            return henValue !== null && henValue !== undefined && henValue !== '' && parseInt(henValue, 10) > -2;
          });
          
          henNamesList.innerHTML = henGuests.map(guest => {
            const henValue = guest.hen;
            let className = 'name-tag';
            
            // Color code based on hen status
            if (henValue !== null && henValue !== undefined && henValue !== '' && parseInt(henValue, 10) === 1) {
              className += ' attending';  // Green for attending
            } else if (henValue !== null && henValue !== undefined && henValue !== '' && parseInt(henValue, 10) === 0) {
              className += ' not-attending';  // Red for not attending
            } else if (henValue !== null && henValue !== undefined && henValue !== '' && parseInt(henValue, 10) === -1) {
              className += ' invited';  // Yellow for invited but no response
            } else {
              className += ' not-invited';  // Gray for not invited
            }
            
            return `<span class="${className}">${guest.name}</span>`;
          }).join('');

          // Update hen count - count only those invited and attending
          const henHeader = document.querySelector('#hen-names h3');
          if (henHeader) {
            const invitedHenGuests = henGuests.filter(guest => {
              const henValue = guest.hen;
              return henValue !== null && henValue !== undefined && henValue !== '' && parseInt(henValue, 10) >= -1;
            });
            const attendingCount = invitedHenGuests.filter(guest => parseInt(guest.hen, 10) === 1).length;
            henHeader.textContent = `Who's Coming (${attendingCount}/${invitedHenGuests.length}):`;
          }
        }

        // Update ceremony names - show ALL guests with color coding
        const ceremonyNamesList = document.getElementById('ceremony-names-list');
        if (ceremonyNamesList) {
          ceremonyNamesList.innerHTML = familyData.map(guest => {
            const ceremonyValue = guest.ceremony;
            let className = 'name-tag';
            
            // Color code based on ceremony status for all guests
            if (ceremonyValue !== null && ceremonyValue !== undefined && ceremonyValue !== '' && parseInt(ceremonyValue, 10) === 1) {
              className += ' attending';  // Green for attending
            } else if (ceremonyValue !== null && ceremonyValue !== undefined && ceremonyValue !== '' && parseInt(ceremonyValue, 10) === 0) {
              className += ' not-attending';  // Red for not attending
            } else if (ceremonyValue !== null && ceremonyValue !== undefined && ceremonyValue !== '' && parseInt(ceremonyValue, 10) === -1) {
              className += ' invited';  // Yellow for invited but no response
            } else {
              className += ' not-invited';  // Gray for not invited
            }
            
            return `<span class="${className}">${guest.name}</span>`;
          }).join('');

          // Update ceremony count - count only those invited and attending
          const ceremonyHeader = document.querySelector('#ceremony-names h3');
          if (ceremonyHeader) {
            const invitedCeremonyGuests = familyData.filter(guest => {
              const ceremonyValue = guest.ceremony;
              return ceremonyValue !== null && ceremonyValue !== undefined && ceremonyValue !== '' && parseInt(ceremonyValue, 10) >= -1;
            });
            const attendingCount = invitedCeremonyGuests.filter(guest => parseInt(guest.ceremony, 10) === 1).length;
            ceremonyHeader.textContent = `Who's Attending the Ceremony (${attendingCount}/${invitedCeremonyGuests.length}):`;
          }
        }
      }

      // Update stag guests selection
      function updateStagGuests() {
        if (!familyData) return;

        const stagGuestsContainer = document.getElementById('stag-guests');
        if (!stagGuestsContainer) return;

        // Filter FAMILY guests who have stag > -2 (invited family members)
        const stagGuests = familyData.filter(guest => {
          const stagValue = guest.stag;
          return stagValue !== null && stagValue !== undefined && stagValue !== '' && parseInt(stagValue, 10) > -2;
        });

        stagGuestsContainer.innerHTML = stagGuests.map(guest => {
          const stagValue = parseInt(guest.stag, 10);
          return `
            <div class="stag-guest" data-guest-id="${guest.id}">
              <div class="stag-guest-name">${guest.name}</div>
              <div class="stag-options">
                <button class="stag-option${stagValue === 1 ? ' is-active' : ''}" data-stag="1" data-guest-id="${guest.id}">I'll be there</button>
                <button class="stag-option${stagValue === 0 ? ' is-active' : ''}" data-stag="0" data-guest-id="${guest.id}">Can't make it</button>
              </div>
            </div>
          `;
        }).join('');

        // Add event listeners to the stag options
        stagGuestsContainer.querySelectorAll('.stag-option').forEach(button => {
          button.addEventListener('click', handleStagSelection);
        });
      }

      // Update hen guests selection
      function updateHenGuests() {
        if (!familyData) return;

        const henGuestsContainer = document.getElementById('hen-guests');
        if (!henGuestsContainer) return;

        // Filter FAMILY guests who have hen > -2 (invited family members)
        const henGuests = familyData.filter(guest => {
          const henValue = guest.hen;
          return henValue !== null && henValue !== undefined && henValue !== '' && parseInt(henValue, 10) > -2;
        });

        henGuestsContainer.innerHTML = henGuests.map(guest => {
          const henValue = parseInt(guest.hen, 10);
          return `
            <div class="hen-guest" data-guest-id="${guest.id}">
              <div class="hen-guest-name">${guest.name}</div>
              <div class="hen-options">
                <button class="hen-option${henValue === 1 ? ' is-active' : ''}" data-hen="1" data-guest-id="${guest.id}">I'll be there</button>
                <button class="hen-option${henValue === 0 ? ' is-active' : ''}" data-hen="0" data-guest-id="${guest.id}">Can't make it</button>
              </div>
            </div>
          `;
        }).join('');

        // Add event listeners to the hen options
        henGuestsContainer.querySelectorAll('.hen-option').forEach(button => {
          button.addEventListener('click', handleHenSelection);
        });
      }

      // Update ceremony guests selection
      function updateCeremonyGuests() {
        if (!familyData) return;

        const ceremonyGuestsContainer = document.getElementById('ceremony-guests');
        if (!ceremonyGuestsContainer) return;

        // Filter guests who are invited to ceremony (ceremony >= -1)
        const ceremonyGuests = familyData.filter(guest => {
          const ceremonyValue = guest.ceremony;
          return ceremonyValue !== null && ceremonyValue !== undefined && ceremonyValue !== '' && parseInt(ceremonyValue, 10) >= -1;
        });

        ceremonyGuestsContainer.innerHTML = ceremonyGuests.map(guest => {
          const ceremonyValue = parseInt(guest.ceremony, 10);
          return `
            <div class="ceremony-guest" data-guest-id="${guest.id}">
              <div class="ceremony-guest-name">${guest.name}</div>
              <div class="ceremony-options">
                <button class="ceremony-option${ceremonyValue === 1 ? ' is-active' : ''}" data-ceremony="1" data-guest-id="${guest.id}">I'll be there</button>
                <button class="ceremony-option${ceremonyValue === 0 ? ' is-active' : ''}" data-ceremony="0" data-guest-id="${guest.id}">Can't make it</button>
              </div>
            </div>
          `;
        }).join('');

        // Add event listeners to the ceremony options
        ceremonyGuestsContainer.querySelectorAll('.ceremony-option').forEach(button => {
          button.addEventListener('click', handleCeremonySelection);
        });
      }

      // Handle stag selection
      async function handleStagSelection(event) {
        const button = event.target;
        const stagValue = parseInt(button.dataset.stag);
        const guestId = button.dataset.guestId;

        if (!currentFamilyCode || !guestId) return;

        // Find the guest in familyData
        const guest = familyData.find(g => g.id === guestId);
        if (!guest) return;

        // If already selected, don't do anything
        if (parseInt(guest.stag, 10) === stagValue) return;

        // Disable all buttons for this guest
        const guestContainer = button.closest('.stag-guest');
        const allButtons = guestContainer.querySelectorAll('.stag-option');
        allButtons.forEach(btn => {
          btn.disabled = true;
          btn.textContent = 'Saving...';
        });

        try {
          const response = await fetch('/api/family/stag-individual', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              family_code: currentFamilyCode,
              guest_id: guestId,
              stag_status: stagValue
            }),
          });

          if (!response.ok) {
            let message = 'Unable to update stag attendance right now.';
            try {
              const payload = await response.json();
              message = payload.description || payload.message || message;
            } catch (_) {
              // noop
            }
            throw new Error(message);
          }

          const result = await response.json();

          // Update local family data
          guest.stag = stagValue;

          // Also update the same guest in allGuests array
          if (allGuests) {
            const allGuestsEntry = allGuests.find(g => g.id === guestId);
            if (allGuestsEntry) {
              allGuestsEntry.stag = stagValue;
            }
          }

          // Update UI
          updateStagGuests();
          updateStagHenCeremonyNames();

          // Show success toast
          showToast(`Stag attendance updated for ${guest.name}!`);

        } catch (error) {
          console.error('Stag attendance update failed:', error);
          showToast(error.message || 'Could not update stag attendance. Please try again.', 'error');

          // Re-enable buttons
          allButtons.forEach(btn => {
            btn.disabled = false;
            const btnStag = parseInt(btn.dataset.stag);
            btn.textContent = btnStag === 1 ? "I'll be there" : "Can't make it";
          });
        }
      }

      // Handle hen selection
      async function handleHenSelection(event) {
        const button = event.target;
        const henValue = parseInt(button.dataset.hen);
        const guestId = button.dataset.guestId;

        if (!currentFamilyCode || !guestId) return;

        // Find the guest in familyData
        const guest = familyData.find(g => g.id === guestId);
        if (!guest) return;

        // If already selected, don't do anything
        if (parseInt(guest.hen, 10) === henValue) return;

        // Disable all buttons for this guest
        const guestContainer = button.closest('.hen-guest');
        const allButtons = guestContainer.querySelectorAll('.hen-option');
        allButtons.forEach(btn => {
          btn.disabled = true;
          btn.textContent = 'Saving...';
        });

        try {
          const response = await fetch('/api/family/hen-individual', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              family_code: currentFamilyCode,
              guest_id: guestId,
              hen_status: henValue
            }),
          });

          if (!response.ok) {
            let message = 'Unable to update hen attendance right now.';
            try {
              const payload = await response.json();
              message = payload.description || payload.message || message;
            } catch (_) {
              // noop
            }
            throw new Error(message);
          }

          const result = await response.json();

          // Update local family data
          guest.hen = henValue;

          // Also update the same guest in allGuests array
          if (allGuests) {
            const allGuestsEntry = allGuests.find(g => g.id === guestId);
            if (allGuestsEntry) {
              allGuestsEntry.hen = henValue;
            }
          }

          // Update UI
          updateHenGuests();
          updateStagHenCeremonyNames();

          // Show success toast
          showToast(`Hen attendance updated for ${guest.name}!`);

        } catch (error) {
          console.error('Hen attendance update failed:', error);
          showToast(error.message || 'Could not update hen attendance. Please try again.', 'error');

          // Re-enable buttons
          allButtons.forEach(btn => {
            btn.disabled = false;
            const btnHen = parseInt(btn.dataset.hen);
            btn.textContent = btnHen === 1 ? "I'll be there" : "Can't make it";
          });
        }
      }

      // Handle ceremony selection
      async function handleCeremonySelection(event) {
        const button = event.target;
        const ceremonyValue = parseInt(button.dataset.ceremony);
        const guestId = button.dataset.guestId;

        if (!currentFamilyCode || !guestId) return;

        // Find the guest in familyData
        const guest = familyData.find(g => g.id === guestId);
        if (!guest) return;

        // If already selected, don't do anything
        if (parseInt(guest.ceremony, 10) === ceremonyValue) return;

        // Disable all buttons for this guest
        const guestContainer = button.closest('.ceremony-guest');
        const allButtons = guestContainer.querySelectorAll('.ceremony-option');
        allButtons.forEach(btn => {
          btn.disabled = true;
          btn.textContent = 'Saving...';
        });

        try {
          const response = await fetch('/api/family/ceremony-individual', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              family_code: currentFamilyCode,
              guest_id: guestId,
              ceremony_status: ceremonyValue
            }),
          });

          if (!response.ok) {
            let message = 'Unable to update ceremony attendance right now.';
            try {
              const payload = await response.json();
              message = payload.description || payload.message || message;
            } catch (_) {
              // noop
            }
            throw new Error(message);
          }

          const result = await response.json();

          // Update local family data
          guest.ceremony = ceremonyValue;

          // Update UI
          updateCeremonyGuests();
          updateStagHenCeremonyNames();

          // Show success toast
          showToast(`Ceremony attendance updated for ${guest.name}!`);

        } catch (error) {
          console.error('Ceremony attendance update failed:', error);
          showToast(error.message || 'Could not update ceremony attendance. Please try again.', 'error');

          // Re-enable buttons
          allButtons.forEach(btn => {
            btn.disabled = false;
            const btnCeremony = parseInt(btn.dataset.ceremony);
            btn.textContent = btnCeremony === 1 ? "I'll be there" : "Can't make it";
          });
        }
      }

      // Update wedding meal guests
      function updateWeddingMealGuests() {
        if (!familyData) return;

        const weddingMealGuestsContainer = document.getElementById('wedding-meal-guests');
        if (!weddingMealGuestsContainer) return;

        // Filter FAMILY guests who are invited to the wedding meal (wedding_meal > -2)
        const weddingMealGuests = familyData.filter(guest => {
          const mealValue = guest.wedding_meal;
          return mealValue !== null && mealValue !== undefined && mealValue !== '' && parseInt(mealValue, 10) > -2;
        });

        console.log('Wedding meal guests found:', weddingMealGuests.length, weddingMealGuests);

        weddingMealGuestsContainer.innerHTML = weddingMealGuests.map(guest => {
          const mealValue = parseInt(guest.wedding_meal, 10);
          return `
            <div class="wedding-meal-guest" data-guest-id="${guest.id}">
              <div class="wedding-meal-guest-name">${guest.name}</div>
              <div class="wedding-meal-options">
                <button class="wedding-meal-option${mealValue === 5 ? ' is-active' : ''}" data-meal="5" data-guest-id="${guest.id}">Beef</button>
                <button class="wedding-meal-option${mealValue === 4 ? ' is-active' : ''}" data-meal="4" data-guest-id="${guest.id}">Fish</button>
                <button class="wedding-meal-option${mealValue === 3 ? ' is-active' : ''}" data-meal="3" data-guest-id="${guest.id}">Vegetarian</button>
                <button class="wedding-meal-option${mealValue === 0 ? ' is-active' : ''}" data-meal="0" data-guest-id="${guest.id}">Not Attending</button>
              </div>
            </div>
          `;
        }).join('');

        // Add event listeners to the meal options
        weddingMealGuestsContainer.querySelectorAll('.wedding-meal-option').forEach(button => {
          button.addEventListener('click', handleWeddingMealSelection);
        });
      }

      // Handle wedding meal selection
      async function handleWeddingMealSelection(event) {
        const button = event.target;
        const mealValue = parseInt(button.dataset.meal);
        const guestId = button.dataset.guestId;

        if (!currentFamilyCode || !guestId) return;

        // Find the guest in familyData
        const guest = familyData.find(g => g.id === guestId);
        if (!guest) return;

        // If already selected, don't do anything
        if (parseInt(guest.wedding_meal, 10) === mealValue) return;

        // Disable all buttons for this guest
        const guestContainer = button.closest('.wedding-meal-guest');
        const allButtons = guestContainer.querySelectorAll('.wedding-meal-option');
        allButtons.forEach(btn => {
          btn.disabled = true;
          btn.textContent = 'Saving...';
        });

        try {
          const response = await fetch('/api/family/wedding-meal', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              family_code: currentFamilyCode,
              guest_id: guestId,
              meal_preference: mealValue
            }),
          });

          if (!response.ok) {
            let message = 'Unable to update meal preference right now.';
            try {
              const payload = await response.json();
              message = payload.description || payload.message || message;
            } catch (_) {
              // noop
            }
            throw new Error(message);
          }

          const result = await response.json();

          // Update local family data
          guest.wedding_meal = mealValue;

          // Update UI
          updateWeddingMealGuests();

          // Show success toast
          showToast(`Meal preference updated for ${guest.name}!`);

        } catch (error) {
          console.error('Wedding meal update failed:', error);
          showToast(error.message || 'Could not update meal preference. Please try again.', 'error');

          // Re-enable buttons
          allButtons.forEach(btn => {
            btn.disabled = false;
            const btnMeal = parseInt(btn.dataset.meal);
            if (btnMeal === 5) {
              btn.textContent = 'Beef';
            } else if (btnMeal === 4) {
              btn.textContent = 'Fish';
            } else if (btnMeal === 3) {
              btn.textContent = 'Vegetarian';
            } else if (btnMeal === 0) {
              btn.textContent = 'Not Attending';
            }
          });
        }
      }

      // Debounced save function for ideas
      function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }

      // Stag ideas saving
      const stagIdeasTextarea = document.getElementById('stag-ideas-text');
      if (stagIdeasTextarea) {
        const saveStagIdeas = debounce(async (ideas) => {
          try {
            const response = await fetch('/api/family/stag-ideas', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ family_code: currentFamilyCode, ideas }),
            });

            if (!response.ok) {
              throw new Error('Failed to save stag ideas');
            }

            showToast('Stag ideas saved!', 'success');
          } catch (error) {
            console.error('Failed to save stag ideas:', error);
            showToast('Failed to save stag ideas', 'error');
          }
        }, 2000);

        stagIdeasTextarea.addEventListener('input', (e) => {
          saveStagIdeas(e.target.value);
        });
      }

      // Hen ideas saving
      const henIdeasTextarea = document.getElementById('hen-ideas-text');
      if (henIdeasTextarea) {
        const saveHenIdeas = debounce(async (ideas) => {
          try {
            const response = await fetch('/api/family/hen-ideas', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ family_code: currentFamilyCode, ideas }),
            });

            if (!response.ok) {
              throw new Error('Failed to save hen ideas');
            }

            showToast('Hen ideas saved!', 'success');
          } catch (error) {
            console.error('Failed to save hen ideas:', error);
            showToast('Failed to save hen ideas', 'error');
          }
        }, 2000);

        henIdeasTextarea.addEventListener('input', (e) => {
          saveHenIdeas(e.target.value);
        });
      }

      // Music requests saving
      const musicRequestsTextarea = document.getElementById('music-requests-text');
      if (musicRequestsTextarea) {
        const saveMusicRequests = debounce(async (requests) => {
          try {
            const response = await fetch('/api/family/music-requests', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ family_code: currentFamilyCode, requests }),
            });

            if (!response.ok) {
              throw new Error('Failed to save music requests');
            }

            showToast('Music requests saved!', 'success');
          } catch (error) {
            console.error('Failed to save music requests:', error);
            showToast('Failed to save music requests', 'error');
          }
        }, 2000);

        musicRequestsTextarea.addEventListener('input', (e) => {
          saveMusicRequests(e.target.value);
        });
      }

      // Stay preference selection
      function initializeStayPreferences() {
        const staySelectButtons = document.querySelectorAll('.stay-select-btn');
        console.log('Initializing stay preferences, found buttons:', staySelectButtons.length);
        
        staySelectButtons.forEach(button => {
          button.addEventListener('click', async (e) => {
            const option = parseInt(e.target.dataset.option);
            const day = e.target.dataset.day; // 'friday' or 'saturday'
            
            console.log('Stay button clicked:', { option, day, currentFamilyCode });
            
            if (!currentFamilyCode) {
              showToast('Please enter a valid family code first', 'error');
              console.error('No currentFamilyCode set!');
              return;
            }

            try {
              // Update UI immediately
              const dayCards = document.querySelectorAll(`.stay-card[data-option]`);
              const dayButtons = document.querySelectorAll(`.stay-select-btn[data-day="${day}"]`);
              
              // Remove selected state from all cards/buttons for this day
              dayCards.forEach(card => {
                if (card.closest(`#${day}-section`)) {
                  card.classList.remove('selected');
                }
              });
              dayButtons.forEach(btn => {
                btn.classList.remove('selected');
                btn.textContent = 'Select This Option';
              });
              
              // Add selected state to clicked option
              const selectedCard = document.querySelector(`#${day}-section .stay-card[data-option="${option}"]`);
              if (selectedCard) {
                selectedCard.classList.add('selected');
                e.target.classList.add('selected');
                e.target.textContent = 'Selected âœ“';
              }

              // Save to database
              const endpoint = day === 'friday' ? '/api/family/friday-stay' : '/api/family/saturday-stay';
              const requestData = { 
                family_code: currentFamilyCode, 
                stay_option: option,
                updated_by: 'family'
              };
              
              console.log('Sending API request:', { endpoint, requestData });
              
              const response = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestData),
              });

              console.log('API response status:', response.status);
              
              if (!response.ok) {
                throw new Error(`Failed to save ${day} stay preference`);
              }

              const result = await response.json();
              console.log('API response data:', result);
              
              // Update local familyData to reflect the change
              familyData.forEach(guest => {
                if (day === 'friday') {
                  guest.friday_stay_preference = option;
                } else {
                  guest.saturday_stay_preference = option;
                }
              });
              
              showToast(result.message, 'success');
              
            } catch (error) {
              console.error(`Failed to save ${day} stay preference:`, error);
              console.error('Full error details:', error);
              showToast(`Failed to save ${day} stay preference`, 'error');
              
              // Revert UI on error
              const selectedCard = document.querySelector(`#${day}-section .stay-card[data-option="${option}"]`);
              if (selectedCard) {
                selectedCard.classList.remove('selected');
                e.target.classList.remove('selected');
                e.target.textContent = 'Select This Option';
              }
            }
          });
        });
      }

      // Load current stay preferences when family data loads
      function updateStayPreferences() {
        if (!familyData || familyData.length === 0) {
          return;
        }

        // Find the first guest's preferences (all family members should have the same preferences)
        const firstGuest = familyData[0];
        
        // Update Friday stay preference
        if (firstGuest.friday_stay_preference) {
          const fridayCard = document.querySelector(`#friday-section .stay-card[data-option="${firstGuest.friday_stay_preference}"]`);
          const fridayButton = document.querySelector(`#friday-section .stay-select-btn[data-option="${firstGuest.friday_stay_preference}"]`);
          
          if (fridayCard && fridayButton) {
            // Clear all Friday selections first
            document.querySelectorAll('#friday-section .stay-card').forEach(card => card.classList.remove('selected'));
            document.querySelectorAll('#friday-section .stay-select-btn').forEach(btn => {
              btn.classList.remove('selected');
              btn.textContent = 'Select This Option';
            });
            
            // Set selected state
            fridayCard.classList.add('selected');
            fridayButton.classList.add('selected');
            fridayButton.textContent = 'Selected âœ“';
          }
        }

        // Update Saturday stay preference
        if (firstGuest.saturday_stay_preference) {
          const saturdayCard = document.querySelector(`#saturday-section .stay-card[data-option="${firstGuest.saturday_stay_preference}"]`);
          const saturdayButton = document.querySelector(`#saturday-section .stay-select-btn[data-option="${firstGuest.saturday_stay_preference}"]`);
          
          if (saturdayCard && saturdayButton) {
            // Clear all Saturday selections first
            document.querySelectorAll('#saturday-section .stay-card').forEach(card => card.classList.remove('selected'));
            document.querySelectorAll('#saturday-section .stay-select-btn').forEach(btn => {
              btn.classList.remove('selected');
              btn.textContent = 'Select This Option';
            });
            
            // Set selected state
            saturdayCard.classList.add('selected');
            saturdayButton.classList.add('selected');
            saturdayButton.textContent = 'Selected âœ“';
          }
        }
      }

      async function loadInstagramPosts() {

        const container = document.getElementById('instagram-feed');

        if (!container) return;

        try {

          const response = await fetch('/api/entertainment/posts');

          if (!response.ok) throw new Error('Network response was not ok');

          const payload = await response.json();

          const posts = Array.isArray(payload.data) ? payload.data.slice(0, 3) : [];

          if (!posts.length) {

            container.innerHTML = '<p>No recent posts available yet. Follow <a href="https://www.instagram.com/beardbanduk" target="_blank" rel="noopener">@beardbanduk</a> for updates.</p>';

            return;

          }

          container.innerHTML = posts.map(post => `

            <article class="insta-card">

              <a href="${post.permalink}" target="_blank" rel="noopener" aria-label="View Instagram post">

                <img src="${post.image_url}" alt="Instagram post preview" loading="lazy">

              </a>

              <footer>

                <a href="${post.permalink}" target="_blank" rel="noopener">${post.caption || 'View on Instagram'}</a>

              </footer>

            </article>

          `).join('');

        } catch (error) {

          console.error('Failed to load Instagram posts', error);

          container.innerHTML = '<p>Instagram feed is temporarily unavailable. Check back soon!</p>';

        }

      }

      

      async function loadFacebookEvents() {

        const container = document.getElementById('facebook-events');

        if (!container) return;

        try {

          const response = await fetch('/api/entertainment/events');

          if (!response.ok) throw new Error('Network response was not ok');

          const payload = await response.json();

          const events = Array.isArray(payload.data) ? payload.data : [];

          if (!events.length) {

            container.innerHTML = '<p>No upcoming events available. Check <a href="https://www.facebook.com/bearduk/events" target="_blank" rel="noopener">Facebook</a> for updates.</p>';

            return;

          }

          container.innerHTML = `

            <div class="events-grid">

              ${events.map(event => `

                <div class="event-card">

                  <div class="event-title">${event.title}</div>

                  <div class="event-date">${event.date}</div>

                  <div class="event-venue">${event.venue}</div>

                  <a href="${event.url}" target="_blank" rel="noopener" class="event-link">View Event</a>

                </div>

              `).join('')}

            </div>

          `;

        } catch (error) {

          console.error('Failed to load Facebook events', error);

          container.innerHTML = '<p>Events feed is temporarily unavailable. Check back soon!</p>';

        }

      }



      // Admin Section Functions

      const ADMIN_INT_FIELDS = new Set(['stag', 'hen', 'friday_room', 'ceremony', 'wedding_meal', 'saturday_room', 'attendance_status']);

      let allAdminGuests = [];



      async function loadAdminGuests() {

        console.log('Starting to load admin guests...');

        try {

          console.log('Making API request to /api/guests...');

          const response = await fetch('/api/guests');

          console.log('API response status:', response.status);



          if (!response.ok) {

            console.error('API response not ok:', response.status, response.statusText);

            throw new Error('Failed to load guest data');

          }



          const data = await response.json();

          console.log('API response data:', data);

          console.log('Number of guests received:', data.data?.length || 0);



          allAdminGuests = data.data || [];

          console.log('Stored admin guests:', allAdminGuests.length);



          renderAdminTable();

          updateAdminStats();


          console.log('Admin guests loaded successfully!');

        } catch (error) {

          console.error('Error loading admin guests:', error);

          document.getElementById('admin-table-body').innerHTML =

            '<tr><td colspan="9" style="color: red;">Error loading guest data</td></tr>';

        }

      }



      function renderAdminTable() {

        const tbody = document.getElementById('admin-table-body');

        if (!tbody) {

          console.warn('Admin table body not found.');

          return;

        }



        if (!allAdminGuests || allAdminGuests.length === 0) {

          tbody.innerHTML = '<tr><td colspan="9" class="loading">No guest data available</td></tr>';

          return;

        }



        // Group guests by family and calculate max engagement score
        const familyGroups = new Map();

        allAdminGuests.forEach(guest => {
          const familyId = guest.family_id || '';
          if (!familyGroups.has(familyId)) {
            familyGroups.set(familyId, []);
          }
          familyGroups.get(familyId).push(guest);
        });

        // Calculate max engagement score for each family
        const familyScores = new Map();
        familyGroups.forEach((guests, familyId) => {
          let maxScore = 0;
          guests.forEach(guest => {
            const fields = ['stag', 'hen', 'friday_room', 'ceremony', 'attendance_status', 'wedding_meal', 'saturday_room'];
            let score = 0;
            fields.forEach(field => {
              const value = guest[field];
              const numValue = value === null || value === undefined || value === '' ? 0 : parseInt(value, 10) || 0;
              score += numValue;
            });
            if (score > maxScore) maxScore = score;
          });
          familyScores.set(familyId, maxScore);
        });

        // Sort families by max score (descending), then by family code
        const sortedFamilyIds = Array.from(familyGroups.keys()).sort((a, b) => {
          const scoreA = familyScores.get(a) || 0;
          const scoreB = familyScores.get(b) || 0;

          if (scoreA !== scoreB) {
            return scoreB - scoreA; // Higher score first
          }

          // If scores are equal, sort by family code
          const famA = a.toString();
          const famB = b.toString();
          return famA.localeCompare(famB, undefined, { numeric: true, sensitivity: 'base' });
        });

        // Flatten back to sorted guests array
        const sortedGuests = [];
        sortedFamilyIds.forEach(familyId => {
          const familyGuests = familyGroups.get(familyId);
          // Sort guests within family by name
          familyGuests.sort((a, b) => {
            const nameA = (a.name || '').toString();
            const nameB = (b.name || '').toString();
            return nameA.localeCompare(nameB, undefined, { sensitivity: 'base' });
          });
          sortedGuests.push(...familyGuests);
        });



        tbody.innerHTML = sortedGuests.map(createGuestRow).join('');

      }



      function createGuestRow(guest) {

        const toInt = (value) => {

          if (value === null || value === undefined || value === '') return null;

          if (typeof value === 'number') return value;

          const parsed = parseInt(value, 10);

          return Number.isNaN(parsed) ? null : parsed;

        };



        const createInput = (field, value, type = 'text') => {

          const inputType = type === 'number' ? 'number' : type === 'email' ? 'email' : 'text';

          return `<input type="${inputType}" value="${value ?? ''}" data-field="${field}" data-guest-id="${guest.id}">`;

        };



        const createSelect = (field, value, options) => {

          const numericValue = toInt(value);
          const colorClass = `value-${numericValue !== null ? numericValue : 'null'}`;

          let select = `<select data-field="${field}" data-guest-id="${guest.id}" class="${colorClass}">`;

          options.forEach(option => {

            const optionValue = option.value === '' ? null : option.value;

            const selected = (numericValue === null && option.value === '') || numericValue === optionValue ? 'selected' : '';

            select += `<option value="${option.value}" ${selected}>${option.label}</option>`;

          });

          select += '</select>';

          return select;

        };



        const createTextarea = (field, value) => {

          return `<textarea data-field="${field}" data-guest-id="${guest.id}" rows="2">${value ?? ''}</textarea>`;

        };



        const familyBadge = guest.family_id ? `<span class="family-badge" title="Family ID">${guest.family_id}</span>` : '';



        const attendanceOptions = [


          { value: -2, label: 'Not Invited' },

          { value: -1, label: 'Invited' },

          { value: 0, label: 'Not Attending' },

          { value: 1, label: 'Attending' }

        ];



        const fridayRoomOptions = [

          { value: -2, label: 'Not Invited' },

          { value: -1, label: 'Invited' },

          { value: 0, label: 'Not Attending' },

          { value: 1, label: 'Attending' },

          { value: 3, label: 'New Place Hotel' },

          { value: 4, label: 'Quab Park Hotel' }

        ];



        const saturdayRoomOptions = [


          { value: -2, label: 'Not Invited' },

          { value: -1, label: 'Invited' },

          { value: 0, label: 'Not Attending' },

          { value: 1, label: 'Attending' },

          { value: 3, label: 'New Place Hotel' },

          { value: 4, label: 'Quab Park Hotel' },

          { value: 5, label: 'Quab Park Estate' }

        ];



        const weddingMealOptions = [


          { value: -2, label: 'Not Invited' },

          { value: -1, label: 'Invited' },

          { value: 0, label: 'Not Attending' },

          { value: 1, label: 'Attending' },

          { value: 5, label: 'Beef' },

          { value: 4, label: 'Fish' },

          { value: 3, label: 'Vegetarian' }

        ];



        return `

          <tr>

            <td><span class="guest-id" data-guest-id="${guest.id}" style="cursor: pointer; color: #6d5ce7; padding: 0.25rem 0.5rem; background: rgba(109, 92, 231, 0.1); border-radius: 4px; display: inline-block;">Open</span></td>

            <td><div class="name-cell">${createInput('name', guest.name)}</div></td>

            <td>${createSelect('stag', guest.stag, attendanceOptions)}</td>

            <td>${createSelect('hen', guest.hen, attendanceOptions)}</td>

            <td>${createSelect('friday_room', guest.friday_room, fridayRoomOptions)}</td>

            <td>${createSelect('ceremony', guest.ceremony, attendanceOptions)}</td>

            <td>${createSelect('attendance_status', guest.attendance_status, attendanceOptions)}</td>

            <td>${createSelect('wedding_meal', guest.wedding_meal, weddingMealOptions)}</td>

            <td>${createSelect('saturday_room', guest.saturday_room, saturdayRoomOptions)}</td>

          </tr>

        `;

      }









      function computeGuestMetric(field) {

        let numerator = 0;

        let denominator = 0;



        (allAdminGuests || []).forEach(guest => {

          const value = guest[field];

          const intValue = value === null || value === undefined || value === '' ? null : parseInt(value, 10);

          if (intValue !== null && intValue >= -1) {

            denominator += 1;

          }

          if (intValue !== null && intValue >= 1) {

            numerator += 1;

          }

        });



        return { numerator, denominator };

      }



      function computeFamilyMetric(field) {

        const families = new Map();



        (allAdminGuests || []).forEach(guest => {

          const key = guest.family_id ? guest.family_id.toString() : `guest-${guest.id}`;

          const valueRaw = guest[field];

          const value = valueRaw === null || valueRaw === undefined || valueRaw === '' ? null : parseInt(valueRaw, 10);

          const entry = families.get(key) || [];

          entry.push(value);

          families.set(key, entry);

        });



        let numerator = 0;

        let denominator = 0;



        families.forEach(values => {

          const hasInvite = values.some(v => v !== null && v >= -1);

          if (hasInvite) {

            denominator += 1;

            if (values.some(v => v !== null && v >= 1)) {

              numerator += 1;

            }

          }

        });



        return { numerator, denominator };

      }



      function updateAdminStats() {

        // Update simple metrics (stag, hen, attendance_status, ceremony)
        const simpleMetrics = [
          { field: 'stag', element: 'stat-stag', compute: computeGuestMetric },
          { field: 'hen', element: 'stat-hen', compute: computeGuestMetric },
          { field: 'attendance_status', element: 'stat-attendance_status', compute: computeGuestMetric },
          { field: 'ceremony', element: 'stat-ceremony', compute: computeGuestMetric },
        ];

        simpleMetrics.forEach(metric => {
          const result = metric.compute(metric.field);
          const target = document.getElementById(metric.element);
          if (target) {
            target.textContent = `${result.numerator} / ${result.denominator}`;
          }
        });

        // Update detailed wedding meal stats
        updateWeddingMealStats();

        // Update detailed Friday room stats
        updateFridayRoomStats();

        // Update detailed Saturday room stats
        updateSaturdayRoomStats();
      }

      function updateWeddingMealStats() {
        let attending = 0;
        let invited = 0;
        let beef = 0;
        let fish = 0;
        let vegetarian = 0;

        (allAdminGuests || []).forEach(guest => {
          const value = guest.wedding_meal;
          const intValue = value === null || value === undefined || value === '' ? null : parseInt(value, 10);

          if (intValue !== null && intValue >= -1) {
            invited++;
          }
          if (intValue !== null && intValue >= 1) {
            attending++;
          }
          if (intValue === 5) beef++;
          if (intValue === 4) fish++;
          if (intValue === 3) vegetarian++;
        });

        document.getElementById('stat-wedding_meal-attending').textContent = attending;
        document.getElementById('stat-wedding_meal-invited').textContent = invited;
        document.getElementById('stat-wedding_meal-beef').textContent = beef;
        document.getElementById('stat-wedding_meal-fish').textContent = fish;
        document.getElementById('stat-wedding_meal-vegetarian').textContent = vegetarian;
      }

      function updateFridayRoomStats() {
        const families = new Map();
        let attending = 0;
        let invited = 0;
        let newPlace = 0;
        let quabPark = 0;

        (allAdminGuests || []).forEach(guest => {
          const familyId = guest.family_id || `guest-${guest.id}`;
          const value = guest.friday_room;
          const intValue = value === null || value === undefined || value === '' ? null : parseInt(value, 10);

          if (!families.has(familyId)) {
            families.set(familyId, []);
          }
          families.get(familyId).push(intValue);
        });

        families.forEach(values => {
          const hasInvite = values.some(v => v !== null && v >= -1);
          if (hasInvite) {
            invited++;
            if (values.some(v => v !== null && v >= 1)) {
              attending++;
            }
          }

          if (values.some(v => v === 2)) newPlace++;
          if (values.some(v => v === 3)) quabPark++;
        });

        document.getElementById('stat-friday_room-attending').textContent = attending;
        document.getElementById('stat-friday_room-invited').textContent = invited;
        document.getElementById('stat-friday_room-newplace').textContent = newPlace;
        document.getElementById('stat-friday_room-quabpark').textContent = quabPark;
      }

      function updateSaturdayRoomStats() {
        const families = new Map();
        let attending = 0;
        let invited = 0;
        let newPlace = 0;
        let quabPark = 0;
        let quabEstate = 0;

        (allAdminGuests || []).forEach(guest => {
          const familyId = guest.family_id || `guest-${guest.id}`;
          const value = guest.saturday_room;
          const intValue = value === null || value === undefined || value === '' ? null : parseInt(value, 10);

          if (!families.has(familyId)) {
            families.set(familyId, []);
          }
          families.get(familyId).push(intValue);
        });

        families.forEach(values => {
          const hasInvite = values.some(v => v !== null && v >= -1);
          if (hasInvite) {
            invited++;
            if (values.some(v => v !== null && v >= 1)) {
              attending++;
            }
          }

          if (values.some(v => v === 2)) newPlace++;
          if (values.some(v => v === 3)) quabPark++;
          if (values.some(v => v === 4)) quabEstate++;
        });

        document.getElementById('stat-saturday_room-attending').textContent = attending;
        document.getElementById('stat-saturday_room-invited').textContent = invited;
        document.getElementById('stat-saturday_room-newplace').textContent = newPlace;
        document.getElementById('stat-saturday_room-quabpark').textContent = quabPark;
        document.getElementById('stat-saturday_room-quabestate').textContent = quabEstate;
      }



      async function loadChangeLog(limit = 50) {

        try {

          const response = await fetch(`/api/guest-changes?limit=${limit}`);

          if (!response.ok) {

            throw new Error('Change log request failed');

          }

          const data = await response.json();

          renderChangeLog(data.data || []);

        } catch (error) {

          console.error('Failed to load change log', error);

          renderChangeLog([]);

        }

      }



      function renderChangeLog(entries) {

        const body = document.getElementById('change-log-body');

        if (!body) return;

        if (!entries.length) {

          body.innerHTML = '<div class="loading">No updates yet</div>';

          return;

        }

        

        // Function to convert numeric values to readable text
        function getReadableValue(columnName, value) {
          if (value === null || value === undefined || value === '') {
            return 'empty';
          }
          
          // Handle text-based columns
          if (['stag_ideas', 'hen_ideas', 'music_requests', 'comment'].includes(columnName)) {
            return value; // Return text as-is for text columns
          }
          
          const numValue = parseInt(value);
          
          // Handle different column types
          switch (columnName) {
            case 'ceremony':
              switch (numValue) {
                case 0: return 'Not Attending';
                case 1: return 'Attending';
                default: return value;
              }
            case 'stag':
              switch (numValue) {
                case -2: return 'Not Invited';
                case -1: return 'Invited - No Response';
                case 0: return 'Not Attending';
                case 1: return 'Attending';
                default: return value;
              }
            case 'hen':
              switch (numValue) {
                case -2: return 'Not Invited';
                case -1: return 'Invited - No Response';
                case 0: return 'Not Attending';
                case 1: return 'Attending';
                default: return value;
              }
            case 'friday_room':
              switch (numValue) {
                case 0: return 'Not Staying';
                case 1: return 'Newplace Hotel';
                case 2: return 'Quab Park';
                case 3: return 'Quab Estate';
                default: return value;
              }
            case 'saturday_room':
              switch (numValue) {
                case 0: return 'Not Staying';
                case 1: return 'Newplace Hotel';
                case 2: return 'Quab Park';
                case 3: return 'Quab Estate';
                default: return value;
              }
            case 'meal':
              switch (numValue) {
                case 0: return 'Not Attending';
                case 1: return 'Attending';
                default: return value;
              }
            default:
              return value;
          }
        }



        const entriesHtml = entries.map(entry => {

          const ukTimestamp = entry.changed_at ? new Date(entry.changed_at).toLocaleString('en-GB', {

            year: 'numeric',

            month: 'short',

            day: 'numeric',

            hour: '2-digit',

            minute: '2-digit',

            second: '2-digit'

          }) : 'n/a';

          const guestName = entry.guest_name || `Guest #${entry.guest_id}`;

          const columnName = entry.column_name || 'unknown';

          const oldVal = getReadableValue(columnName, entry.old_value);

          const newVal = getReadableValue(columnName, entry.new_value);

          return `<div style="padding: 0.5rem 0; border-bottom: 1px solid rgba(0, 0, 0, 0.1); font-family: monospace; font-size: 0.9rem;">

            <strong>${ukTimestamp}:</strong> ${guestName}, [${columnName}], ${oldVal} &gt; ${newVal}

          </div>`;

        }).join('');



        body.innerHTML = entriesHtml;

      }



      function showGuestPopup(guestId) {

        const guest = allAdminGuests.find(g => g.id == guestId);

        if (!guest) return;



        const guestLink = `${window.location.origin}${window.location.pathname}?family_code=${guest.family_id || ''}`;



        const popup = document.createElement('div');

        popup.className = 'guest-popup';

        popup.innerHTML = `

          <div class="guest-popup-content">

            <button class="close-btn" onclick="this.closest('.guest-popup').remove()">Ã—</button>

            <h3>Guest Details: ${guest.name}</h3>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1rem 0;">

              <div>

                <p><strong>Guest ID:</strong> ${guest.id}</p>

                <p><strong>Family Code:</strong> ${guest.family_id || 'None'}</p>

                <p><strong>Email:</strong> ${guest.email || 'Not provided'}</p>

                <p><strong>Mobile:</strong> ${guest.mobile || 'Not provided'}</p>

              </div>

              <div>

                <p><strong>Address:</strong> ${guest.address || 'Not provided'}</p>

                <p><strong>Music Requests:</strong> ${guest.music_requests || 'None'}</p>

              </div>

            </div>

            <div style="margin: 1rem 0;">

              <p><strong>Restrictions:</strong></p>

              <div style="background: rgba(255, 255, 255, 0.1); padding: 0.5rem; border-radius: 4px; font-style: italic;">

                ${guest.restrictions || 'No restrictions specified'}

              </div>

            </div>

            <div style="margin: 1rem 0;">

              <p><strong>Comments:</strong></p>

              <div style="background: rgba(255, 255, 255, 0.1); padding: 0.5rem; border-radius: 4px; font-style: italic;">

                ${guest.comment || 'No comments'}

              </div>

            </div>

            <div style="background: rgba(109, 92, 231, 0.1); padding: 1rem; border-radius: 8px; margin: 1rem 0;">

              <h4 style="margin-top: 0; color: #6d5ce7;">Personalized Invitation Message:</h4>

              <p style="font-style: italic; margin-bottom: 0;">

                "Dear ${guest.name},<br><br>

                You are invited to celebrate the wedding of James & Heather!<br><br>

                Please use this personal link to RSVP and view all the wedding details:<br>

                <a href="${guestLink}" style="color: #6d5ce7; text-decoration: underline;">${guestLink}</a><br><br>

                We can't wait to celebrate with you!"

              </p>

            </div>

            <p><strong>Direct Link:</strong></p>

            <a href="${guestLink}" class="guest-link" target="_blank">${guestLink}</a>

            <p><em>Click the link above to copy and send to the guest</em></p>

          </div>

        `;



        document.body.appendChild(popup);

        

        // Close popup when clicking outside

        popup.addEventListener('click', (e) => {

          if (e.target === popup) {

            popup.remove();

          }

        });

      }



      async function saveGuestField(guestId, field, value) {

        try {

          const response = await fetch(`/api/guests/${guestId}`, {

            method: 'PATCH',

            headers: { 'Content-Type': 'application/json' },

            body: JSON.stringify({ [field]: value })

          });



          if (!response.ok) {

            throw new Error('Failed to save changes');

          }



          const guest = allAdminGuests.find(g => g.id == guestId);

          if (guest) {

            if (value === '') {

              guest[field] = null;

            } else if (ADMIN_INT_FIELDS.has(field)) {

              const parsed = parseInt(value, 10);

              guest[field] = Number.isNaN(parsed) ? null : parsed;

            } else {

              guest[field] = value;

            }

          }



          updateAdminStats();

          loadChangeLog();



          showToast(`Updated ${field} successfully`, 'success');

        } catch (error) {

          console.error('Error saving guest field:', error);

          showToast(`Failed to update ${field}`, 'error');

        }

      }



      function initializeAdminSection() {

        console.log('Initializing admin section...');



        // Load admin data when admin section becomes visible

        const adminSection = document.getElementById('admin-section');

        console.log('Admin section element:', adminSection);

        console.log('Admin section classes:', adminSection?.className);

        console.log('Admin section hidden?', adminSection?.classList.contains('hidden'));



        // Always try to load admin data, regardless of visibility check

        console.log('Loading admin guest data...');

        loadAdminGuests();

        loadChangeLog();

        // Handle guest ID clicks

        document.addEventListener('click', (e) => {

          if (e.target.classList.contains('guest-id')) {

            const guestId = e.target.dataset.guestId;

            showGuestPopup(guestId);

          }

        });



        // Fallback: Check periodically if admin section becomes visible

        const checkAdminVisibility = () => {

          const adminSection = document.getElementById('admin-section');

          if (adminSection && !adminSection.classList.contains('hidden') && allAdminGuests.length === 0) {

            console.log('Admin section became visible, loading data...');

            loadAdminGuests();

          }

        };



        // Check every 2 seconds for the first 30 seconds

        let checkCount = 0;

        const visibilityCheck = setInterval(() => {

          checkCount++;

          if (checkCount > 15) { // Stop after 30 seconds

            clearInterval(visibilityCheck);

            return;

          }

          checkAdminVisibility();

        }, 2000);



        // Handle input blur (for text inputs and textareas)

        document.addEventListener('blur', (e) => {

          const target = e.target;

          if ((target.tagName === 'INPUT' || target.tagName === 'TEXTAREA') && target.dataset.guestId && target.dataset.field) {

            const guestId = target.dataset.guestId;

            const field = target.dataset.field;

            let value = target.value;



            // Convert empty strings to null for certain fields

            if (value === '' && ['age'].includes(field)) {

              value = null;

            }



            saveGuestField(guestId, field, value);

          }

        });



        // Handle field changes (inputs, selects, textareas)

        document.addEventListener('change', (e) => {

          const target = e.target;

          if (target.dataset.guestId && target.dataset.field) {

            const guestId = target.dataset.guestId;

            const field = target.dataset.field;

            let value = target.value;



            // Convert empty strings to null for appropriate fields

            if (value === '') {

              if (['stag', 'hen', 'friday_room', 'ceremony', 'wedding_meal', 'saturday_room', 'attendance_status'].includes(field)) {

                value = null;

              } else if (['age'].includes(field)) {

                value = null;

              }

            }

            // Update color-coding for select elements
            if (target.tagName === 'SELECT') {
              // Remove all existing value classes
              target.className = target.className.replace(/value-[-\w]+/g, '').trim();
              // Add new value class
              const colorClass = `value-${value !== null ? value : 'null'}`;
              target.className += ` ${colorClass}`;
            }

            saveGuestField(guestId, field, value);

          }

        });

      }

      // AI Suggestions functionality
      async function loadAISuggestions(suggestionType) {
        try {
          const response = await fetch(`/api/ai/${suggestionType}`);
          if (!response.ok) {
            throw new Error('Failed to load AI suggestions');
          }
          const suggestions = await response.json();
          return suggestions;
        } catch (error) {
          console.error('Error loading AI suggestions:', error);
          return [];
        }
      }

      async function displayAISuggestions(suggestionType, containerId) {
        const container = document.getElementById(containerId);
        if (!container) return;

        container.innerHTML = 'Loading suggestions...';
        
        const suggestions = await loadAISuggestions(suggestionType);
        
        if (suggestions.length === 0) {
          container.innerHTML = 'No suggestions available.';
          return;
        }

        container.innerHTML = suggestions.map(suggestion => 
          `<div class="ai-suggestion-item">${suggestion.ai}</div>`
        ).join('');
      }

      // Initialize AI suggestions when DOM is loaded
      function initializeAISuggestions() {
        // Load stag suggestions
        displayAISuggestions('stag', 'stag-ai-content');
        
        // Load hen suggestions  
        displayAISuggestions('hen', 'hen-ai-content');
      }

      loadInstagramPosts();

      loadFacebookEvents();

      // Initialize stay preference functionality
      initializeStayPreferences();
      // Initialize AI suggestions
      initializeAISuggestions();



      // Manual trigger for debugging (call from browser console)

      window.forceLoadAdminData = () => {

        console.log('Manual admin data load triggered');

        loadAdminGuests();

      };

    </script>

  </body>

</html>


